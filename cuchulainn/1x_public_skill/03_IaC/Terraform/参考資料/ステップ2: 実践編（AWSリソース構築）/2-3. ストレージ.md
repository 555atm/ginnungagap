# 2-3. ストレージ

AWSのストレージサービス（S3、EBS、EFS、FSx）の構築方法を説明します。

## 2-3-1. S3バケットの作成

### バケットの基本作成

基本的なS3バケットを作成します。

```hcl
resource "aws_s3_bucket" "example" {
  bucket = "my-unique-bucket-name-12345"
  
  tags = {
    Name        = "Example Bucket"
    Environment = "dev"
  }
}
```

### バケット名の制約

- グローバルで一意である必要がある
- 3〜63文字
- 小文字、数字、ハイフン、ピリオドのみ
- IPアドレス形式は不可
- `xn--`で始まってはいけない

```hcl
# ランダムなサフィックスを使用して一意性を確保
resource "random_id" "bucket_suffix" {
  byte_length = 4
}

resource "aws_s3_bucket" "example" {
  bucket = "my-bucket-${random_id.bucket_suffix.hex}"
}
```

### バージョニングの有効化

オブジェクトのバージョン管理を有効にします。

```hcl
resource "aws_s3_bucket_versioning" "example" {
  bucket = aws_s3_bucket.example.id
  
  versioning_configuration {
    status = "Enabled"
  }
}
```

### ライフサイクルポリシーの設定

オブジェクトのライフサイクルを管理します。

```hcl
resource "aws_s3_bucket_lifecycle_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    id     = "transition-to-glacier"
    status = "Enabled"
    
    transition {
      days          = 30
      storage_class = "GLACIER"
    }
  }
  
  rule {
    id     = "delete-old-versions"
    status = "Enabled"
    
    noncurrent_version_expiration {
      noncurrent_days = 90
    }
  }
}
```

### 暗号化の設定（SSE-S3、SSE-KMS）

#### SSE-S3（サーバー側暗号化 - S3管理）

```hcl
resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

#### SSE-KMS（サーバー側暗号化 - KMS管理）

```hcl
resource "aws_kms_key" "s3_key" {
  description = "S3バケット用のKMSキー"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.s3_key.arn
    }
  }
}
```

### パブリックアクセスのブロック

パブリックアクセスをブロックします（セキュリティベストプラクティス）。

```hcl
resource "aws_s3_bucket_public_access_block" "example" {
  bucket = aws_s3_bucket.example.id
  
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### CORS設定

CORS（Cross-Origin Resource Sharing）を設定します。

```hcl
resource "aws_s3_bucket_cors_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  cors_rule {
    allowed_headers = ["*"]
    allowed_methods = ["GET", "PUT", "POST"]
    allowed_origins = ["https://example.com"]
    expose_headers  = ["ETag"]
    max_age_seconds = 3000
  }
}
```

### バケットポリシーの設定

バケットポリシーを設定します。

```hcl
resource "aws_s3_bucket_policy" "example" {
  bucket = aws_s3_bucket.example.id
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::ACCOUNT_ID:user/username"
        }
        Action = [
          "s3:GetObject",
          "s3:PutObject"
        ]
        Resource = "${aws_s3_bucket.example.arn}/*"
      }
    ]
  })
}
```

### 静的ウェブサイトホスティング

静的ウェブサイトホスティングを有効にします。

```hcl
resource "aws_s3_bucket_website_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  index_document {
    suffix = "index.html"
  }
  
  error_document {
    key = "error.html"
  }
}

resource "aws_s3_bucket_public_access_block" "example" {
  bucket = aws_s3_bucket.example.id
  
  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}
```

## 2-3-2. S3オブジェクトの管理

### オブジェクトのアップロード

TerraformでS3オブジェクトをアップロードします。

```hcl
resource "aws_s3_object" "example" {
  bucket = aws_s3_bucket.example.id
  key    = "path/to/file.txt"
  source = "local-file.txt"
  
  etag = filemd5("local-file.txt")
}
```

### オブジェクトのアクセス制御

ACLを使用してオブジェクトのアクセスを制御します。

```hcl
resource "aws_s3_object" "example" {
  bucket       = aws_s3_bucket.example.id
  key          = "private-file.txt"
  source       = "private-file.txt"
  acl          = "private"
  content_type = "text/plain"
}
```

### プリサインドURLの生成

プリサインドURLは、Terraformではなくアプリケーション側で生成します。データソースを使用して既存のオブジェクトを参照できます。

```hcl
data "aws_s3_object" "example" {
  bucket = aws_s3_bucket.example.id
  key    = "path/to/file.txt"
}
```

## 2-3-3. EBSボリュームの作成

### EBSボリュームの基本作成

EBSボリュームを作成します。

```hcl
resource "aws_ebs_volume" "example" {
  availability_zone = "ap-northeast-1a"
  size              = 20
  type              = "gp3"
  
  tags = {
    Name = "example-volume"
  }
}
```

### ボリュームタイプの選択（gp3、io1、io2）

#### gp3（General Purpose SSD）

```hcl
resource "aws_ebs_volume" "gp3" {
  availability_zone = "ap-northeast-1a"
  size              = 100
  type              = "gp3"
  iops              = 3000
  throughput        = 125
}
```

#### io1（Provisioned IOPS SSD）

```hcl
resource "aws_ebs_volume" "io1" {
  availability_zone = "ap-northeast-1a"
  size              = 100
  type              = "io1"
  iops              = 4000
}
```

#### io2（Provisioned IOPS SSD - 最新）

```hcl
resource "aws_ebs_volume" "io2" {
  availability_zone = "ap-northeast-1a"
  size              = 100
  type              = "io2"
  iops              = 4000
}
```

### サイズの指定

```hcl
resource "aws_ebs_volume" "example" {
  availability_zone = "ap-northeast-1a"
  size              = 50  # GB単位
  type              = "gp3"
}
```

### 暗号化の設定

EBSボリュームを暗号化します。

```hcl
resource "aws_ebs_volume" "encrypted" {
  availability_zone = "ap-northeast-1a"
  size              = 20
  type              = "gp3"
  encrypted         = true
  kms_key_id        = aws_kms_key.ebs_key.arn
  
  tags = {
    Name = "encrypted-volume"
  }
}
```

### スナップショットの作成

EBSスナップショットを作成します。

```hcl
resource "aws_ebs_snapshot" "example" {
  volume_id = aws_ebs_volume.example.id
  
  tags = {
    Name = "example-snapshot"
  }
}
```

### ボリュームのアタッチ

EC2インスタンスにボリュームをアタッチします。

```hcl
resource "aws_volume_attachment" "example" {
  device_name = "/dev/sdf"
  volume_id   = aws_ebs_volume.example.id
  instance_id = aws_instance.web.id
}
```

## 2-3-4. EFSファイルシステムの作成

### EFSファイルシステムの基本作成

EFSファイルシステムを作成します。

```hcl
resource "aws_efs_file_system" "example" {
  creation_token = "my-efs"
  
  tags = {
    Name = "example-efs"
  }
}
```

### パフォーマンスモードの選択

```hcl
resource "aws_efs_file_system" "example" {
  creation_token   = "my-efs"
  performance_mode = "generalPurpose"  # または "maxIO"
  
  tags = {
    Name = "example-efs"
  }
}
```

- `generalPurpose`: 一般的な用途（デフォルト）
- `maxIO`: 高いIOPSが必要な場合

### スループットモードの選択

```hcl
resource "aws_efs_file_system" "example" {
  creation_token = "my-efs"
  
  throughput_mode = "provisioned"  # または "bursting"
  provisioned_throughput_in_mibps = 100
  
  tags = {
    Name = "example-efs"
  }
}
```

### マウントターゲットの作成

EFSをマウントするためのターゲットを作成します。

```hcl
resource "aws_efs_mount_target" "example" {
  file_system_id  = aws_efs_file_system.example.id
  subnet_id       = aws_subnet.private.id
  security_groups = [aws_security_group.efs.id]
}
```

### アクセスポイントの作成

EFSアクセスポイントを作成します。

```hcl
resource "aws_efs_access_point" "example" {
  file_system_id = aws_efs_file_system.example.id
  
  posix_user {
    gid = 1000
    uid = 1000
  }
  
  root_directory {
    path = "/example"
    creation_info {
      owner_gid   = 1000
      owner_uid   = 1000
      permissions = "755"
    }
  }
  
  tags = {
    Name = "example-access-point"
  }
}
```

### バックアップポリシーの設定

EFSのバックアップを有効にします。

```hcl
resource "aws_efs_backup_policy" "example" {
  file_system_id = aws_efs_file_system.example.id
  
  backup_policy {
    status = "ENABLED"
  }
}
```

## 2-3-5. FSxの作成

### FSx for Windows File Server

Windowsファイルサーバーを作成します。

```hcl
resource "aws_fsx_windows_file_system" "example" {
  active_directory_id = aws_directory_service_directory.example.id
  storage_capacity   = 300
  subnet_ids         = [aws_subnet.private1.id, aws_subnet.private2.id]
  throughput_capacity = 32
  
  tags = {
    Name = "example-fsx-windows"
  }
}
```

### FSx for Lustre

高性能コンピューティング用のファイルシステムを作成します。

```hcl
resource "aws_fsx_lustre_file_system" "example" {
  storage_capacity            = 1200
  subnet_ids                 = [aws_subnet.private.id]
  deployment_type            = "PERSISTENT_1"
  per_unit_storage_throughput = 200
  
  tags = {
    Name = "example-fsx-lustre"
  }
}
```

### FSx for NetApp ONTAP

NetApp ONTAPファイルシステムを作成します。

```hcl
resource "aws_fsx_ontap_file_system" "example" {
  storage_capacity    = 1024
  subnet_ids          = [aws_subnet.private1.id, aws_subnet.private2.id]
  deployment_type     = "MULTI_AZ_1"
  throughput_capacity = 512
  
  tags = {
    Name = "example-fsx-ontap"
  }
}
```
