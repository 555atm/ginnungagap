# 2-2. 権限管理

IAM（Identity and Access Management）を使用した権限管理について説明します。

## 2-2-1. IAMの基礎

### IAMユーザーの作成

IAMユーザーを作成します。

```hcl
resource "aws_iam_user" "developer" {
  name = "developer-user"
  
  tags = {
    Name = "Developer User"
  }
}
```

### IAMグループの作成

IAMグループを作成し、ユーザーを追加します。

```hcl
resource "aws_iam_group" "developers" {
  name = "developers"
}

resource "aws_iam_group_membership" "developers" {
  name = "developers-group-membership"
  users = [
    aws_iam_user.developer.name
  ]
  group = aws_iam_group.developers.name
}
```

### IAMロールの作成

IAMロールを作成します。

```hcl
resource "aws_iam_role" "ec2_role" {
  name = "ec2-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
}
```

### IAMポリシーの作成

IAMポリシーを作成します。

```hcl
resource "aws_iam_policy" "s3_read_policy" {
  name        = "s3-read-policy"
  description = "S3読み取り専用ポリシー"
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:ListBucket"
        ]
        Resource = [
          "arn:aws:s3:::my-bucket/*",
          "arn:aws:s3:::my-bucket"
        ]
      }
    ]
  })
}
```

## 2-2-2. IAMロール・ポリシーの作成

### インスタンスプロファイルの作成

EC2インスタンスにアタッチするためのインスタンスプロファイルを作成します。

```hcl
resource "aws_iam_role" "ec2_role" {
  name = "ec2-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
}

resource "aws_iam_instance_profile" "ec2_profile" {
  name = "ec2-instance-profile"
  role = aws_iam_role.ec2_role.name
}

# EC2インスタンスにアタッチ
resource "aws_instance" "web" {
  iam_instance_profile = aws_iam_instance_profile.ec2_profile.name
  # ...
}
```

### サービスロールの作成

AWSサービスが使用するロールを作成します。

```hcl
resource "aws_iam_role" "lambda_role" {
  name = "lambda-execution-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "lambda.amazonaws.com"
        }
      }
    ]
  })
}
```

### カスタムポリシーの作成

カスタムポリシーを作成してロールにアタッチします。

```hcl
resource "aws_iam_policy" "custom_policy" {
  name        = "custom-policy"
  description = "カスタムポリシー"
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:PutObject"
        ]
        Resource = "arn:aws:s3:::my-bucket/*"
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "custom_policy_attach" {
  role       = aws_iam_role.example.name
  policy_arn = aws_iam_policy.custom_policy.arn
}
```

### インラインポリシー vs マネージドポリシー

#### インラインポリシー

ロールに直接埋め込まれるポリシーです。

```hcl
resource "aws_iam_role" "example" {
  name = "example-role"
  
  inline_policy {
    name = "inline-policy"
    policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        {
          Effect = "Allow"
          Action = "s3:GetObject"
          Resource = "*"
        }
      ]
    })
  }
}
```

**メリット:**
- シンプル
- ロールと一緒に管理

**デメリット:**
- 再利用不可
- 複数のロールで同じポリシーを使えない

#### マネージドポリシー

独立したポリシーリソースです。

```hcl
resource "aws_iam_policy" "managed_policy" {
  name = "managed-policy"
  policy = jsonencode({
    # ポリシードキュメント
  })
}

resource "aws_iam_role_policy_attachment" "attach" {
  role       = aws_iam_role.example.name
  policy_arn = aws_iam_policy.managed_policy.arn
}
```

**メリット:**
- 再利用可能
- 複数のロールで共有可能
- 管理が容易

**デメリット:**
- 少し複雑

### ポリシードキュメントの書き方

#### 基本的な構造

```hcl
policy = jsonencode({
  Version = "2012-10-17"
  Statement = [
    {
      Effect   = "Allow"  # または "Deny"
      Action   = "s3:GetObject"
      Resource = "arn:aws:s3:::my-bucket/*"
    }
  ]
})
```

#### 複数のアクション

```hcl
policy = jsonencode({
  Version = "2012-10-17"
  Statement = [
    {
      Effect = "Allow"
      Action = [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ]
      Resource = "arn:aws:s3:::my-bucket/*"
    }
  ]
})
```

#### 条件の追加

```hcl
policy = jsonencode({
  Version = "2012-10-17"
  Statement = [
    {
      Effect = "Allow"
      Action = "s3:GetObject"
      Resource = "arn:aws:s3:::my-bucket/*"
      Condition = {
        StringEquals = {
          "s3:x-amz-server-side-encryption" = "AES256"
        }
      }
    }
  ]
})
```

## 2-2-3. タスクロールとタスク実行ロール

### ECSタスクロールの作成

ECSタスク内のアプリケーションが使用するロールです。

```hcl
resource "aws_iam_role" "ecs_task_role" {
  name = "ecs-task-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ecs-tasks.amazonaws.com"
        }
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "ecs_task_policy" {
  role       = aws_iam_role.ecs_task_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
}
```

### ECSタスク実行ロールの作成

ECSエージェントが使用するロールです（ECRからイメージをプルするなど）。

```hcl
resource "aws_iam_role" "ecs_execution_role" {
  name = "ecs-execution-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ecs-tasks.amazonaws.com"
        }
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "ecs_execution_policy" {
  role       = aws_iam_role.ecs_execution_role.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
}
```

### ロールの使い分け

- **タスクロール**: アプリケーションがAWSサービスにアクセスする際に使用
- **タスク実行ロール**: ECSエージェントがイメージをプルしたり、ログを送信する際に使用

### 最小権限の原則

必要最小限の権限のみを付与します。

```hcl
# 悪い例: 全てのS3アクセスを許可
resource "aws_iam_role_policy" "bad_example" {
  policy = jsonencode({
    Statement = [{
      Effect   = "Allow"
      Action   = "s3:*"
      Resource = "*"
    }]
  })
}

# 良い例: 必要なアクセスのみ許可
resource "aws_iam_role_policy" "good_example" {
  policy = jsonencode({
    Statement = [{
      Effect = "Allow"
      Action = [
        "s3:GetObject",
        "s3:PutObject"
      ]
      Resource = "arn:aws:s3:::specific-bucket/*"
    }]
  })
}
```

## 2-2-4. クロスアカウントアクセス

### クロスアカウントロールの設定

別のAWSアカウントからアクセスできるロールを作成します。

```hcl
# 信頼されるアカウント（Account A）
resource "aws_iam_role" "cross_account_role" {
  name = "cross-account-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::ACCOUNT_B_ID:root"
        }
        Action = "sts:AssumeRole"
        Condition = {
          StringEquals = {
            "sts:ExternalId" = "unique-external-id"
          }
        }
      }
    ]
  })
}
```

### AssumeRoleの設定

別のアカウントのロールを引き受ける設定です。

```hcl
# Account BからAccount Aのロールを使用
provider "aws" {
  alias = "account_a"
  
  assume_role {
    role_arn = "arn:aws:iam::ACCOUNT_A_ID:role/cross-account-role"
    external_id = "unique-external-id"
  }
}

resource "aws_s3_bucket" "example" {
  provider = aws.account_a
  bucket   = "example-bucket"
}
```

### 外部IDの利用

セキュリティを強化するために外部IDを使用します。

```hcl
resource "aws_iam_role" "cross_account" {
  assume_role_policy = jsonencode({
    Statement = [{
      Effect = "Allow"
      Principal = {
        AWS = "arn:aws:iam::TRUSTED_ACCOUNT:root"
      }
      Action = "sts:AssumeRole"
      Condition = {
        StringEquals = {
          "sts:ExternalId" = var.external_id
        }
      }
    }]
  })
}
```

## 2-2-5. IAMベストプラクティス

### 最小権限の原則

必要最小限の権限のみを付与します。

```hcl
# 特定のリソースのみアクセス可能にする
resource "aws_iam_policy" "minimal_policy" {
  policy = jsonencode({
    Statement = [{
      Effect = "Allow"
      Action = "s3:GetObject"
      Resource = "arn:aws:s3:::specific-bucket/specific-path/*"
    }]
  })
}
```

### ポリシーのテスト方法

#### IAM Policy Simulatorを使用

AWSコンソールのIAM Policy Simulatorでポリシーをテストできます。

#### Terraformでのテスト

```hcl
# テスト用のポリシーを作成
resource "aws_iam_policy" "test_policy" {
  name = "test-policy"
  policy = jsonencode({
    # ポリシードキュメント
  })
}

# テスト用のロールにアタッチ
resource "aws_iam_role_policy_attachment" "test" {
  role       = aws_iam_role.test_role.name
  policy_arn = aws_iam_policy.test_policy.arn
}
```

### 権限の監査方法

#### CloudTrailで監査

```hcl
resource "aws_cloudtrail" "audit" {
  name = "audit-trail"
  
  s3_bucket_name = aws_s3_bucket.cloudtrail.id
  
  event_selector {
    read_write_type                 = "All"
    include_management_events       = true
    exclude_management_event_sources = []
  }
}
```

#### IAM Access Analyzerを使用

```hcl
resource "aws_accessanalyzer_analyzer" "example" {
  analyzer_name = "example-analyzer"
  type          = "ACCOUNT"
}
```

#### 定期的な権限レビュー

- 未使用のポリシーを削除
- 必要以上の権限を削減
- 定期的な監査を実施
