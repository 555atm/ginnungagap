# 2-10. データストア

AWSのデータストアサービス（RDS、Aurora、DynamoDB、ElastiCacheなど）の構築方法を説明します。

## 2-10-1. RDSの作成

### RDSインスタンスの基本作成

RDSインスタンスを作成します。

```hcl
resource "aws_db_instance" "main" {
  identifier             = "main-db"
  engine                 = "mysql"
  engine_version         = "8.0"
  instance_class         = "db.t3.micro"
  allocated_storage      = 20
  storage_type           = "gp3"
  db_name                = "mydb"
  username               = "admin"
  password               = var.db_password
  parameter_group_name   = aws_db_parameter_group.main.name
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]
  skip_final_snapshot    = true
  
  tags = {
    Name = "main-database"
  }
}
```

### エンジンの選択（MySQL、PostgreSQL、MariaDB、Oracle、SQL Server）

```hcl
# MySQL
resource "aws_db_instance" "mysql" {
  engine         = "mysql"
  engine_version = "8.0.35"
  # ...
}

# PostgreSQL
resource "aws_db_instance" "postgres" {
  engine         = "postgres"
  engine_version = "15.4"
  # ...
}

# MariaDB
resource "aws_db_instance" "mariadb" {
  engine         = "mariadb"
  engine_version = "10.11.6"
  # ...
}

# Oracle
resource "aws_db_instance" "oracle" {
  engine         = "oracle-ee"
  engine_version = "19.0.0.0.ru-2023-10.rur-2023-10.r1"
  license_model  = "bring-your-own-license"
  # ...
}

# SQL Server
resource "aws_db_instance" "sqlserver" {
  engine         = "sqlserver-ex"
  engine_version = "15.00.4335.1.v1"
  license_model  = "license-included"
  # ...
}
```

### インスタンスクラスの選択

```hcl
# バースト可能（開発環境）
resource "aws_db_instance" "dev" {
  instance_class = "db.t3.micro"   # 2 vCPU, 1 GB RAM
  # instance_class = "db.t3.small"  # 2 vCPU, 2 GB RAM
  # instance_class = "db.t3.medium" # 2 vCPU, 4 GB RAM
}

# 汎用（本番環境）
resource "aws_db_instance" "prod" {
  instance_class = "db.m6i.large"    # 2 vCPU, 8 GB RAM
  # instance_class = "db.m6i.xlarge"  # 4 vCPU, 16 GB RAM
  # instance_class = "db.m6i.2xlarge" # 8 vCPU, 32 GB RAM
}

# メモリ最適化
resource "aws_db_instance" "memory" {
  instance_class = "db.r6i.large"  # 2 vCPU, 16 GB RAM
}
```

### ストレージの設定

```hcl
resource "aws_db_instance" "main" {
  allocated_storage     = 100        # 初期サイズ（GB）
  max_allocated_storage = 1000       # 自動スケーリングの上限
  storage_type          = "gp3"      # gp2, gp3, io1
  iops                  = 3000       # gp3, io1の場合
  storage_encrypted     = true
  kms_key_id            = aws_kms_key.rds.arn
}
```

### マルチAZの設定

高可用性のためにマルチAZを有効にします。

```hcl
resource "aws_db_instance" "main" {
  identifier          = "main-db"
  multi_az            = true  # マルチAZ有効化
  availability_zone   = null  # マルチAZの場合は指定しない
  
  # ...
}
```

### バックアップの設定

自動バックアップを設定します。

```hcl
resource "aws_db_instance" "main" {
  backup_retention_period = 7           # バックアップ保持期間（日）
  backup_window           = "03:00-04:00"  # バックアップウィンドウ（UTC）
  maintenance_window      = "mon:04:00-mon:05:00"  # メンテナンスウィンドウ
  
  # ...
}
```

### スナップショットの作成

手動スナップショットを作成します。

```hcl
resource "aws_db_snapshot" "main" {
  db_instance_identifier = aws_db_instance.main.id
  db_snapshot_identifier = "main-snapshot-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"
  
  tags = {
    Name = "main-snapshot"
  }
}
```

### パラメータグループの作成

カスタムパラメータグループを作成します。

```hcl
resource "aws_db_parameter_group" "main" {
  name   = "main-mysql-params"
  family = "mysql8.0"
  
  parameter {
    name  = "character_set_server"
    value = "utf8mb4"
  }
  
  parameter {
    name  = "collation_server"
    value = "utf8mb4_unicode_ci"
  }
  
  parameter {
    name  = "max_connections"
    value = "200"
  }
  
  tags = {
    Name = "main-parameter-group"
  }
}
```

### オプショングループの設定

オプショングループを設定します。

```hcl
resource "aws_db_option_group" "main" {
  name                     = "main-mysql-options"
  option_group_description = "Main MySQL option group"
  engine_name              = "mysql"
  major_engine_version     = "8.0"
  
  option {
    option_name = "MARIADB_AUDIT_PLUGIN"
    
    option_settings {
      name  = "SERVER_AUDIT_EVENTS"
      value = "CONNECT"
    }
  }
}
```

### セキュリティグループの設定

RDS用のセキュリティグループを作成します。

```hcl
resource "aws_security_group" "rds" {
  name        = "rds-sg"
  description = "Security group for RDS"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port       = 3306
    to_port         = 3306
    protocol        = "tcp"
    security_groups = [aws_security_group.app.id]
    description     = "Allow MySQL from application servers"
  }
  
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  tags = {
    Name = "rds-security-group"
  }
}
```

### サブネットグループの作成

RDS用のサブネットグループを作成します。

```hcl
resource "aws_db_subnet_group" "main" {
  name       = "main-db-subnet-group"
  subnet_ids = [
    aws_subnet.private_1a.id,
    aws_subnet.private_1c.id
  ]
  
  tags = {
    Name = "main-db-subnet-group"
  }
}
```

### 読み取りレプリカの作成

読み取りレプリカを作成します。

```hcl
resource "aws_db_instance" "replica" {
  identifier             = "main-db-replica"
  replicate_source_db    = aws_db_instance.main.identifier
  instance_class         = "db.t3.micro"
  publicly_accessible    = false
  skip_final_snapshot    = true
  
  tags = {
    Name = "main-database-replica"
  }
}
```

## 2-10-2. Auroraの作成

### Auroraクラスターの作成

Auroraクラスターを作成します。

```hcl
resource "aws_rds_cluster" "main" {
  cluster_identifier      = "main-aurora-cluster"
  engine                  = "aurora-mysql"
  engine_version          = "8.0.mysql_aurora.3.04.0"
  database_name           = "mydb"
  master_username         = "admin"
  master_password         = var.db_password
  db_subnet_group_name    = aws_db_subnet_group.main.name
  vpc_security_group_ids  = [aws_security_group.aurora.id]
  backup_retention_period = 7
  preferred_backup_window = "03:00-04:00"
  skip_final_snapshot     = true
  
  tags = {
    Name = "main-aurora-cluster"
  }
}

resource "aws_rds_cluster_instance" "main" {
  count              = 2
  identifier         = "main-aurora-instance-${count.index}"
  cluster_identifier = aws_rds_cluster.main.id
  instance_class     = "db.r6g.large"
  engine             = aws_rds_cluster.main.engine
  engine_version     = aws_rds_cluster.main.engine_version
  
  tags = {
    Name = "main-aurora-instance-${count.index}"
  }
}
```

### クラスターエンドポイントの設定

クラスターエンドポイントを出力します。

```hcl
output "aurora_cluster_endpoint" {
  value       = aws_rds_cluster.main.endpoint
  description = "Aurora cluster endpoint (write)"
}

output "aurora_reader_endpoint" {
  value       = aws_rds_cluster.main.reader_endpoint
  description = "Aurora cluster reader endpoint (read)"
}
```

### 読み取りエンドポイントの設定

カスタムエンドポイントを作成します。

```hcl
resource "aws_rds_cluster_endpoint" "analytics" {
  cluster_identifier          = aws_rds_cluster.main.id
  cluster_endpoint_identifier = "analytics"
  custom_endpoint_type        = "READER"
  
  static_members = [
    aws_rds_cluster_instance.main[1].id
  ]
  
  tags = {
    Name = "analytics-endpoint"
  }
}
```

### サーバーレスv2の設定

Aurora Serverless v2を設定します。

```hcl
resource "aws_rds_cluster" "serverless" {
  cluster_identifier  = "serverless-aurora-cluster"
  engine              = "aurora-mysql"
  engine_mode         = "provisioned"
  engine_version      = "8.0.mysql_aurora.3.04.0"
  database_name       = "mydb"
  master_username     = "admin"
  master_password     = var.db_password
  skip_final_snapshot = true
  
  serverlessv2_scaling_configuration {
    max_capacity = 2.0
    min_capacity = 0.5
  }
}

resource "aws_rds_cluster_instance" "serverless" {
  cluster_identifier = aws_rds_cluster.serverless.id
  instance_class     = "db.serverless"
  engine             = aws_rds_cluster.serverless.engine
  engine_version     = aws_rds_cluster.serverless.engine_version
}
```

### グローバルデータベースの設定

Aurora Global Databaseを設定します。

```hcl
# プライマリリージョン（ap-northeast-1）
resource "aws_rds_global_cluster" "main" {
  global_cluster_identifier = "main-global-cluster"
  engine                    = "aurora-mysql"
  engine_version            = "8.0.mysql_aurora.3.04.0"
  database_name             = "mydb"
}

resource "aws_rds_cluster" "primary" {
  cluster_identifier        = "primary-cluster"
  global_cluster_identifier = aws_rds_global_cluster.main.id
  engine                    = aws_rds_global_cluster.main.engine
  engine_version            = aws_rds_global_cluster.main.engine_version
  master_username           = "admin"
  master_password           = var.db_password
  skip_final_snapshot       = true
}

# セカンダリリージョン（us-east-1）
resource "aws_rds_cluster" "secondary" {
  provider                  = aws.us_east_1
  cluster_identifier        = "secondary-cluster"
  global_cluster_identifier = aws_rds_global_cluster.main.id
  engine                    = aws_rds_global_cluster.main.engine
  engine_version            = aws_rds_global_cluster.main.engine_version
  skip_final_snapshot       = true
}
```

## 2-10-3. DynamoDBテーブルの作成

### テーブルの基本作成

DynamoDBテーブルを作成します。

```hcl
resource "aws_dynamodb_table" "main" {
  name           = "main-table"
  billing_mode   = "PAY_PER_REQUEST"  # または "PROVISIONED"
  hash_key       = "id"
  range_key      = "timestamp"
  
  attribute {
    name = "id"
    type = "S"
  }
  
  attribute {
    name = "timestamp"
    type = "N"
  }
  
  tags = {
    Name = "main-dynamodb-table"
  }
}
```

### パーティションキーとソートキーの設計

```hcl
resource "aws_dynamodb_table" "users" {
  name         = "users"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "user_id"      # パーティションキー
  range_key    = "created_at"   # ソートキー
  
  attribute {
    name = "user_id"
    type = "S"
  }
  
  attribute {
    name = "created_at"
    type = "N"
  }
}
```

### グローバルセカンダリインデックス（GSI）

GSIを作成します。

```hcl
resource "aws_dynamodb_table" "users" {
  name         = "users"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "user_id"
  
  attribute {
    name = "user_id"
    type = "S"
  }
  
  attribute {
    name = "email"
    type = "S"
  }
  
  attribute {
    name = "status"
    type = "S"
  }
  
  global_secondary_index {
    name            = "email-index"
    hash_key        = "email"
    projection_type = "ALL"
  }
  
  global_secondary_index {
    name            = "status-index"
    hash_key        = "status"
    range_key       = "user_id"
    projection_type = "INCLUDE"
    non_key_attributes = ["email", "name"]
  }
}
```

### ローカルセカンダリインデックス（LSI）

LSIを作成します。

```hcl
resource "aws_dynamodb_table" "orders" {
  name         = "orders"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "user_id"
  range_key    = "order_id"
  
  attribute {
    name = "user_id"
    type = "S"
  }
  
  attribute {
    name = "order_id"
    type = "S"
  }
  
  attribute {
    name = "order_date"
    type = "N"
  }
  
  local_secondary_index {
    name            = "order-date-index"
    range_key       = "order_date"
    projection_type = "ALL"
  }
}
```

### オンデマンド vs プロビジョンドキャパシティ

```hcl
# オンデマンド（従量課金）
resource "aws_dynamodb_table" "ondemand" {
  name         = "ondemand-table"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "id"
  
  attribute {
    name = "id"
    type = "S"
  }
}

# プロビジョンド（固定キャパシティ）
resource "aws_dynamodb_table" "provisioned" {
  name           = "provisioned-table"
  billing_mode   = "PROVISIONED"
  read_capacity  = 5
  write_capacity = 5
  hash_key       = "id"
  
  attribute {
    name = "id"
    type = "S"
  }
}
```

### オートスケーリングの設定

プロビジョンドキャパシティのオートスケーリングを設定します。

```hcl
resource "aws_appautoscaling_target" "dynamodb_read" {
  max_capacity       = 100
  min_capacity       = 5
  resource_id        = "table/${aws_dynamodb_table.provisioned.name}"
  scalable_dimension = "dynamodb:table:ReadCapacityUnits"
  service_namespace  = "dynamodb"
}

resource "aws_appautoscaling_policy" "dynamodb_read" {
  name               = "DynamoDBReadCapacityUtilization"
  policy_type        = "TargetTrackingScaling"
  resource_id        = aws_appautoscaling_target.dynamodb_read.resource_id
  scalable_dimension = aws_appautoscaling_target.dynamodb_read.scalable_dimension
  service_namespace  = aws_appautoscaling_target.dynamodb_read.service_namespace
  
  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "DynamoDBReadCapacityUtilization"
    }
    target_value = 70.0
  }
}
```

### TTLの設定

Time To Live（TTL）を設定します。

```hcl
resource "aws_dynamodb_table" "sessions" {
  name         = "sessions"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "session_id"
  
  attribute {
    name = "session_id"
    type = "S"
  }
  
  ttl {
    attribute_name = "expiration_time"
    enabled        = true
  }
}
```

### ストリームの有効化

DynamoDB Streamsを有効にします。

```hcl
resource "aws_dynamodb_table" "main" {
  name         = "main-table"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "id"
  
  attribute {
    name = "id"
    type = "S"
  }
  
  stream_enabled   = true
  stream_view_type = "NEW_AND_OLD_IMAGES"  # NEW_IMAGE, OLD_IMAGE, NEW_AND_OLD_IMAGES, KEYS_ONLY
}
```

### バックアップの設定

ポイントインタイムリカバリーを有効にします。

```hcl
resource "aws_dynamodb_table" "main" {
  name         = "main-table"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "id"
  
  attribute {
    name = "id"
    type = "S"
  }
  
  point_in_time_recovery {
    enabled = true
  }
}
```

### ポイントインタイムリカバリー（PITR）

オンデマンドバックアップを作成します。

```hcl
resource "aws_dynamodb_table_item" "backup" {
  table_name = aws_dynamodb_table.main.name
  hash_key   = aws_dynamodb_table.main.hash_key
  
  item = jsonencode({
    id = { S = "backup-config" }
    backup_enabled = { BOOL = true }
  })
}
```

## 2-10-4. ElastiCacheの設定

### Redisクラスターの作成

ElastiCache for Redisクラスターを作成します。

```hcl
resource "aws_elasticache_replication_group" "redis" {
  replication_group_id       = "main-redis"
  replication_group_description = "Main Redis cluster"
  engine                     = "redis"
  engine_version             = "7.0"
  node_type                  = "cache.t3.micro"
  num_cache_clusters         = 2
  parameter_group_name       = aws_elasticache_parameter_group.redis.name
  subnet_group_name          = aws_elasticache_subnet_group.main.name
  security_group_ids         = [aws_security_group.redis.id]
  automatic_failover_enabled = true
  at_rest_encryption_enabled = true
  transit_encryption_enabled = true
  
  tags = {
    Name = "main-redis-cluster"
  }
}
```

### Memcachedクラスターの作成

ElastiCache for Memcachedクラスターを作成します。

```hcl
resource "aws_elasticache_cluster" "memcached" {
  cluster_id           = "main-memcached"
  engine               = "memcached"
  engine_version       = "1.6.17"
  node_type            = "cache.t3.micro"
  num_cache_nodes      = 2
  parameter_group_name = "default.memcached1.6"
  subnet_group_name    = aws_elasticache_subnet_group.main.name
  security_group_ids   = [aws_security_group.memcached.id]
  
  tags = {
    Name = "main-memcached-cluster"
  }
}
```

### パラメータグループの設定

ElastiCache用のパラメータグループを作成します。

```hcl
resource "aws_elasticache_parameter_group" "redis" {
  name   = "main-redis-params"
  family = "redis7"
  
  parameter {
    name  = "maxmemory-policy"
    value = "allkeys-lru"
  }
  
  parameter {
    name  = "timeout"
    value = "300"
  }
}
```

### サブネットグループの作成

ElastiCache用のサブネットグループを作成します。

```hcl
resource "aws_elasticache_subnet_group" "main" {
  name       = "main-cache-subnet-group"
  subnet_ids = [
    aws_subnet.private_1a.id,
    aws_subnet.private_1c.id
  ]
  
  tags = {
    Name = "main-cache-subnet-group"
  }
}
```

### スナップショットの設定

自動スナップショットを設定します。

```hcl
resource "aws_elasticache_replication_group" "redis" {
  replication_group_id          = "main-redis"
  snapshot_retention_limit      = 5
  snapshot_window               = "03:00-05:00"
  final_snapshot_identifier     = "main-redis-final-snapshot"
  
  # ...
}
```

## 2-10-5. DocumentDB

### DocumentDBクラスターの作成

DocumentDBクラスターを作成します。

```hcl
resource "aws_docdb_cluster" "main" {
  cluster_identifier      = "main-docdb-cluster"
  engine                  = "docdb"
  master_username         = "admin"
  master_password         = var.docdb_password
  backup_retention_period = 7
  preferred_backup_window = "03:00-05:00"
  skip_final_snapshot     = true
  db_subnet_group_name    = aws_docdb_subnet_group.main.name
  vpc_security_group_ids  = [aws_security_group.docdb.id]
  
  tags = {
    Name = "main-docdb-cluster"
  }
}

resource "aws_docdb_cluster_instance" "main" {
  count              = 2
  identifier         = "main-docdb-instance-${count.index}"
  cluster_identifier = aws_docdb_cluster.main.id
  instance_class     = "db.t3.medium"
  
  tags = {
    Name = "main-docdb-instance-${count.index}"
  }
}
```

### インスタンスの設定

DocumentDBインスタンスを設定します。

```hcl
resource "aws_docdb_subnet_group" "main" {
  name       = "main-docdb-subnet-group"
  subnet_ids = [
    aws_subnet.private_1a.id,
    aws_subnet.private_1c.id
  ]
  
  tags = {
    Name = "main-docdb-subnet-group"
  }
}
```

### パラメータグループの設定

DocumentDB用のパラメータグループを作成します。

```hcl
resource "aws_docdb_cluster_parameter_group" "main" {
  family = "docdb5.0"
  name   = "main-docdb-params"
  
  parameter {
    name  = "tls"
    value = "enabled"
  }
  
  parameter {
    name  = "audit_logs"
    value = "enabled"
  }
}
```
