# 2-1. 全体設計

Terraformプロジェクトの設計と構造について説明します。

## 2-1-1. プロジェクト構造の設計

### モノリシック構造 vs モジュール構造

#### モノリシック構造

全てのリソースを1つのディレクトリに配置する構造です。小規模なプロジェクトに適しています。

```
project/
├── main.tf
├── variables.tf
├── outputs.tf
└── terraform.tfvars
```

**メリット:**
- シンプルで理解しやすい
- 小規模プロジェクトに適している

**デメリット:**
- 大規模になると管理が困難
- 再利用性が低い

#### モジュール構造

機能ごとにモジュールに分割する構造です。大規模なプロジェクトに適しています。

```
project/
├── modules/
│   ├── vpc/
│   ├── ec2/
│   └── rds/
├── environments/
│   ├── dev/
│   ├── staging/
│   └── prod/
└── main.tf
```

**メリット:**
- 再利用性が高い
- 大規模プロジェクトに適している
- 保守性が高い

**デメリット:**
- 初期設計が複雑
- 小規模プロジェクトには過剰

### 環境ごとの分離方法

#### ディレクトリベースの分離

```
project/
├── environments/
│   ├── dev/
│   │   ├── main.tf
│   │   └── terraform.tfvars
│   ├── staging/
│   │   ├── main.tf
│   │   └── terraform.tfvars
│   └── prod/
│       ├── main.tf
│       └── terraform.tfvars
└── modules/
```

#### ワークスペースベースの分離

```bash
# ワークスペースを作成
terraform workspace new dev
terraform workspace new prod

# ワークスペースを切り替え
terraform workspace select dev
```

### リソースのグループ化

関連するリソースをグループ化します。

```
modules/
├── networking/
│   ├── vpc.tf
│   ├── subnets.tf
│   └── security-groups.tf
├── compute/
│   ├── ec2.tf
│   └── autoscaling.tf
└── storage/
    ├── s3.tf
    └── ebs.tf
```

### ディレクトリ命名規則

- 小文字とハイフンを使用: `my-module`, `web-server`
- 意味のある名前を付ける
- 一貫性を保つ

## 2-1-2. ディレクトリ構成

### 基本的なディレクトリ構造

```
terraform-project/
├── main.tf              # メインのリソース定義
├── variables.tf         # 変数定義
├── outputs.tf          # 出力値定義
├── terraform.tfvars    # 変数の値（環境ごと）
├── versions.tf         # バージョン固定
├── .terraform/         # プロバイダーキャッシュ（gitignore）
├── terraform.tfstate   # ステートファイル（gitignore）
└── .gitignore
```

### `modules/`ディレクトリの活用

再利用可能なモジュールを配置します。

```
modules/
├── vpc/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
├── ec2/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
└── rds/
    ├── main.tf
    ├── variables.tf
    └── outputs.tf
```

使用例：

```hcl
module "vpc" {
  source = "./modules/vpc"
  
  vpc_cidr = "10.0.0.0/16"
  environment = "dev"
}
```

### `environments/`ディレクトリの設計

環境ごとの設定を分離します。

```
environments/
├── dev/
│   ├── main.tf
│   ├── terraform.tfvars
│   └── backend.tf
├── staging/
│   ├── main.tf
│   ├── terraform.tfvars
│   └── backend.tf
└── prod/
    ├── main.tf
    ├── terraform.tfvars
    └── backend.tf
```

### `scripts/`ディレクトリの配置

補助スクリプトを配置します。

```
scripts/
├── deploy.sh          # デプロイスクリプト
├── destroy.sh         # 削除スクリプト
└── validate.sh        # バリデーションスクリプト
```

### 設定ファイル（`.tfvars`）の配置

環境ごとに設定ファイルを配置します。

```
environments/
├── dev/
│   └── terraform.tfvars
├── staging/
│   └── terraform.tfvars
└── prod/
    └── terraform.tfvars
```

## 2-1-3. 命名規則

### リソース名の命名規則

- 小文字とアンダースコアを使用
- 意味のある名前を付ける
- 一貫性を保つ

```hcl
# 良い例
resource "aws_instance" "web_server" {}
resource "aws_s3_bucket" "application_logs" {}

# 悪い例
resource "aws_instance" "ws" {}
resource "aws_s3_bucket" "bucket1" {}
```

### 変数名の命名規則

- 小文字とアンダースコアを使用
- 明確な名前を付ける

```hcl
# 良い例
variable "instance_type" {}
variable "vpc_cidr_block" {}

# 悪い例
variable "type" {}
variable "cidr" {}
```

### モジュール名の命名規則

- 小文字とハイフンを使用
- 機能を表す名前を付ける

```
modules/
├── vpc-network/
├── web-server/
└── database-cluster/
```

### タグの命名規則

一貫したタグ付けを行います。

```hcl
locals {
  common_tags = {
    Project     = "my-project"
    Environment = var.environment
    ManagedBy   = "Terraform"
    Owner       = "devops-team"
  }
}
```

### AWSリソース名の制約

- S3バケット名: グローバルで一意、小文字とハイフンのみ
- IAMロール名: 最大64文字、英数字と特定の記号のみ
- VPC名: タグで管理、リソース名には制約なし

## 2-1-4. ファイル構成

### `main.tf`の役割

メインのリソース定義を記述します。

```hcl
# main.tf
terraform {
  required_version = ">= 1.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.region
}

# リソース定義
resource "aws_vpc" "main" {
  cidr_block = var.vpc_cidr
  
  tags = local.common_tags
}
```

### `variables.tf`の役割

変数の定義を記述します。

```hcl
# variables.tf
variable "region" {
  type        = string
  description = "AWSリージョン"
  default     = "ap-northeast-1"
}

variable "vpc_cidr" {
  type        = string
  description = "VPCのCIDRブロック"
}
```

### `outputs.tf`の役割

出力値を定義します。

```hcl
# outputs.tf
output "vpc_id" {
  value       = aws_vpc.main.id
  description = "VPCのID"
}

output "vpc_cidr" {
  value       = aws_vpc.main.cidr_block
  description = "VPCのCIDRブロック"
}
```

### `terraform.tfvars`の使い方

変数の値を設定します。

```hcl
# terraform.tfvars
region   = "ap-northeast-1"
vpc_cidr = "10.0.0.0/16"
environment = "dev"
```

使用例：

```bash
terraform apply -var-file="terraform.tfvars"
```

### `versions.tf`でのバージョン固定

バージョンを固定して、一貫性を保ちます。

```hcl
# versions.tf
terraform {
  required_version = ">= 1.0, < 2.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

**バージョン指定の例:**
- `">= 1.0"`: 1.0以上
- `"~> 1.0"`: 1.0以上2.0未満
- `"= 1.0.0"`: 正確に1.0.0
