# 2-8. 鍵管理

AWSの鍵管理サービス（KMS、Secrets Manager、Parameter Store）の構築方法を説明します。

## 2-8-1. KMSキーの作成

### カスタマーマネージドキー（CMK）の作成

KMSキーを作成します。

```hcl
resource "aws_kms_key" "main" {
  description             = "Main KMS key"
  deletion_window_in_days = 30
  enable_key_rotation     = true
  
  tags = {
    Name = "main-kms-key"
  }
}
```

### キーポリシーの設定

KMSキーのポリシーを設定します。

```hcl
resource "aws_kms_key" "main" {
  description             = "Main KMS key"
  deletion_window_in_days = 30
  enable_key_rotation     = true
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "Enable IAM User Permissions"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {
        Sid    = "Allow services to use the key"
        Effect = "Allow"
        Principal = {
          Service = [
            "s3.amazonaws.com",
            "rds.amazonaws.com",
            "secretsmanager.amazonaws.com"
          ]
        }
        Action = [
          "kms:Decrypt",
          "kms:GenerateDataKey"
        ]
        Resource = "*"
      },
      {
        Sid    = "Allow specific IAM role to use the key"
        Effect = "Allow"
        Principal = {
          AWS = aws_iam_role.app.arn
        }
        Action = [
          "kms:Decrypt",
          "kms:DescribeKey"
        ]
        Resource = "*"
      }
    ]
  })
}
```

### キーの有効化/無効化

キーの有効化状態を管理します。

```hcl
resource "aws_kms_key" "main" {
  description             = "Main KMS key"
  deletion_window_in_days = 30
  is_enabled              = true  # false で無効化
}
```

### キーのローテーション

自動キーローテーションを有効にします。

```hcl
resource "aws_kms_key" "main" {
  description             = "Main KMS key"
  deletion_window_in_days = 30
  enable_key_rotation     = true  # 自動ローテーション（年1回）
  
  tags = {
    Name = "main-kms-key"
  }
}
```

### エイリアスの作成

KMSキーにエイリアスを設定します。

```hcl
resource "aws_kms_alias" "main" {
  name          = "alias/main-key"
  target_key_id = aws_kms_key.main.key_id
}

# エイリアスを使用してキーを参照
resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = "alias/main-key"
    }
  }
}
```

### キーの削除保護

削除保護を設定します。

```hcl
resource "aws_kms_key" "main" {
  description             = "Main KMS key"
  deletion_window_in_days = 30  # 7〜30日の範囲で設定
  
  # ライフサイクルで削除を防止
  lifecycle {
    prevent_destroy = true
  }
  
  tags = {
    Name = "main-kms-key"
  }
}
```

## 2-8-2. Secrets Managerの設定

### シークレットの作成

Secrets Managerでシークレットを作成します。

```hcl
resource "aws_secretsmanager_secret" "db_password" {
  name                    = "db-password"
  description             = "Database password"
  recovery_window_in_days = 30
  
  tags = {
    Name = "db-password"
  }
}

resource "aws_secretsmanager_secret_version" "db_password" {
  secret_id     = aws_secretsmanager_secret.db_password.id
  secret_string = jsonencode({
    username = "admin"
    password = var.db_password
  })
}
```

### シークレットの取得

データソースでシークレットを取得します。

```hcl
data "aws_secretsmanager_secret" "db_password" {
  name = "db-password"
}

data "aws_secretsmanager_secret_version" "db_password" {
  secret_id = data.aws_secretsmanager_secret.db_password.id
}

locals {
  db_credentials = jsondecode(data.aws_secretsmanager_secret_version.db_password.secret_string)
}

# RDSで使用
resource "aws_db_instance" "main" {
  username = local.db_credentials.username
  password = local.db_credentials.password
  # ...
}
```

### シークレットのローテーション

Lambda関数を使用した自動ローテーションを設定します。

```hcl
resource "aws_secretsmanager_secret_rotation" "db_password" {
  secret_id           = aws_secretsmanager_secret.db_password.id
  rotation_lambda_arn = aws_lambda_function.rotate_secret.arn
  
  rotation_rules {
    automatically_after_days = 30
  }
}
```

### Lambda関数での自動ローテーション

ローテーション用のLambda関数を作成します。

```hcl
resource "aws_lambda_function" "rotate_secret" {
  filename      = "rotate_secret.zip"
  function_name = "rotate-secret"
  role          = aws_iam_role.lambda_rotation.arn
  handler       = "index.handler"
  runtime       = "python3.11"
  
  environment {
    variables = {
      SECRET_ARN = aws_secretsmanager_secret.db_password.arn
    }
  }
}

resource "aws_iam_role" "lambda_rotation" {
  name = "lambda-rotation-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "lambda.amazonaws.com"
      }
    }]
  })
}

resource "aws_iam_role_policy" "lambda_rotation" {
  role = aws_iam_role.lambda_rotation.id
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "secretsmanager:DescribeSecret",
          "secretsmanager:GetSecretValue",
          "secretsmanager:PutSecretValue",
          "secretsmanager:UpdateSecretVersionStage"
        ]
        Resource = aws_secretsmanager_secret.db_password.arn
      }
    ]
  })
}
```

### シークレットの参照方法

アプリケーションからシークレットを参照します。

```hcl
# ECSタスク定義でシークレットを参照
resource "aws_ecs_task_definition" "app" {
  family = "app"
  
  container_definitions = jsonencode([
    {
      name  = "app"
      image = "app:latest"
      
      secrets = [
        {
          name      = "DB_PASSWORD"
          valueFrom = aws_secretsmanager_secret.db_password.arn
        }
      ]
    }
  ])
}
```

## 2-8-3. Parameter Storeの利用

### パラメータの作成

Systems Manager Parameter Storeでパラメータを作成します。

```hcl
resource "aws_ssm_parameter" "db_host" {
  name  = "/app/db/host"
  type  = "String"
  value = aws_db_instance.main.endpoint
  
  tags = {
    Name = "db-host"
  }
}

resource "aws_ssm_parameter" "db_password" {
  name  = "/app/db/password"
  type  = "SecureString"
  value = var.db_password
  
  tags = {
    Name = "db-password"
  }
}
```

### 標準パラメータ vs 高度なパラメータ

```hcl
# 標準パラメータ（無料、4KB以下）
resource "aws_ssm_parameter" "standard" {
  name  = "/app/config/standard"
  type  = "String"
  value = "standard value"
  tier  = "Standard"
}

# 高度なパラメータ（有料、8KB以下、ポリシー設定可能）
resource "aws_ssm_parameter" "advanced" {
  name  = "/app/config/advanced"
  type  = "String"
  value = "advanced value"
  tier  = "Advanced"
  
  # 有効期限ポリシー
  lifecycle {
    ignore_changes = [value]
  }
}
```

### パラメータの暗号化

KMSで暗号化されたパラメータを作成します。

```hcl
resource "aws_ssm_parameter" "encrypted" {
  name   = "/app/db/password"
  type   = "SecureString"
  value  = var.db_password
  key_id = aws_kms_key.main.id
  
  tags = {
    Name = "encrypted-parameter"
  }
}
```

### パラメータの階層構造

階層構造でパラメータを管理します。

```hcl
# 開発環境
resource "aws_ssm_parameter" "dev_db_host" {
  name  = "/app/dev/db/host"
  type  = "String"
  value = aws_db_instance.dev.endpoint
}

resource "aws_ssm_parameter" "dev_db_password" {
  name  = "/app/dev/db/password"
  type  = "SecureString"
  value = var.dev_db_password
}

# 本番環境
resource "aws_ssm_parameter" "prod_db_host" {
  name  = "/app/prod/db/host"
  type  = "String"
  value = aws_db_instance.prod.endpoint
}

resource "aws_ssm_parameter" "prod_db_password" {
  name  = "/app/prod/db/password"
  type  = "SecureString"
  value = var.prod_db_password
}
```

### パラメータの参照方法

データソースでパラメータを取得します。

```hcl
# 単一パラメータの取得
data "aws_ssm_parameter" "db_host" {
  name = "/app/db/host"
}

# 暗号化されたパラメータの取得
data "aws_ssm_parameter" "db_password" {
  name            = "/app/db/password"
  with_decryption = true
}

# パスによる複数パラメータの取得
data "aws_ssm_parameters_by_path" "app_config" {
  path            = "/app/config"
  with_decryption = true
  recursive       = true
}

# 使用例
resource "aws_instance" "app" {
  user_data = <<-EOF
    #!/bin/bash
    DB_HOST="${data.aws_ssm_parameter.db_host.value}"
    DB_PASSWORD="${data.aws_ssm_parameter.db_password.value}"
  EOF
}
```

### パラメータストアとSecrets Managerの使い分け

| 特徴 | Parameter Store | Secrets Manager |
|------|----------------|-----------------|
| 料金 | 標準パラメータは無料 | 有料 |
| 自動ローテーション | なし | あり |
| バージョン管理 | 最大100バージョン | 全バージョン |
| クロスアカウント | 不可 | 可能 |
| 用途 | 設定値、非機密情報 | パスワード、APIキー |

```hcl
# Parameter Store: 設定値
resource "aws_ssm_parameter" "app_config" {
  name  = "/app/config/timeout"
  type  = "String"
  value = "30"
}

# Secrets Manager: 機密情報
resource "aws_secretsmanager_secret" "api_key" {
  name = "api-key"
}

resource "aws_secretsmanager_secret_version" "api_key" {
  secret_id     = aws_secretsmanager_secret.api_key.id
  secret_string = var.api_key
}
```
