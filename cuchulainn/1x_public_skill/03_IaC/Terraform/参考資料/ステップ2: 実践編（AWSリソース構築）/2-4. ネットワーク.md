# 2-4. ネットワーク

AWSのネットワークリソース（VPC、サブネット、ゲートウェイなど）の構築方法を説明します。

## 2-4-1. VPCの作成

### VPCの基本作成

基本的なVPCを作成します。

```hcl
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
  
  tags = {
    Name = "main-vpc"
  }
}
```

### CIDRブロックの設計

VPCのCIDRブロックを設計します。

```hcl
# 大規模なネットワーク
resource "aws_vpc" "large" {
  cidr_block = "10.0.0.0/16"  # 65,536 IPアドレス
}

# 中規模なネットワーク
resource "aws_vpc" "medium" {
  cidr_block = "10.0.0.0/20"  # 4,096 IPアドレス
}

# 小規模なネットワーク
resource "aws_vpc" "small" {
  cidr_block = "10.0.0.0/24"  # 256 IPアドレス
}
```

### IPv6の有効化

IPv6を有効にします。

```hcl
resource "aws_vpc" "main" {
  cidr_block                       = "10.0.0.0/16"
  assign_generated_ipv6_cidr_block = true
  
  tags = {
    Name = "main-vpc"
  }
}
```

### DNS設定

DNSの設定を行います。

```hcl
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true  # DNSホスト名を有効化
  enable_dns_support   = true  # DNS解決を有効化
  
  tags = {
    Name = "main-vpc"
  }
}
```

### DHCPオプションセット

DHCPオプションセットを設定します。

```hcl
resource "aws_vpc_dhcp_options" "main" {
  domain_name         = "example.com"
  domain_name_servers = ["AmazonProvidedDNS"]
  ntp_servers         = ["169.254.169.123"]
  
  tags = {
    Name = "main-dhcp-options"
  }
}

resource "aws_vpc_dhcp_options_association" "main" {
  vpc_id          = aws_vpc.main.id
  dhcp_options_id = aws_vpc_dhcp_options.main.id
}
```

## 2-4-2. サブネットの作成

### パブリックサブネットの作成

インターネットに接続可能なパブリックサブネットを作成します。

```hcl
resource "aws_subnet" "public_1a" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "ap-northeast-1a"
  map_public_ip_on_launch = true
  
  tags = {
    Name = "public-subnet-1a"
    Type = "Public"
  }
}
```

### プライベートサブネットの作成

インターネットに直接接続できないプライベートサブネットを作成します。

```hcl
resource "aws_subnet" "private_1a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.10.0/24"
  availability_zone = "ap-northeast-1a"
  
  tags = {
    Name = "private-subnet-1a"
    Type = "Private"
  }
}
```

### サブネットのCIDR設計

サブネットのCIDRブロックを設計します。

```hcl
# VPC: 10.0.0.0/16
# パブリックサブネット: 10.0.1.0/24, 10.0.2.0/24
# プライベートサブネット: 10.0.10.0/24, 10.0.11.0/24
# データベースサブネット: 10.0.20.0/24, 10.0.21.0/24

resource "aws_subnet" "public" {
  count = 2
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 1}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]
  
  tags = {
    Name = "public-subnet-${count.index + 1}"
  }
}
```

### アベイラビリティゾーンの分散

複数のアベイラビリティゾーンにサブネットを分散配置します。

```hcl
data "aws_availability_zones" "available" {
  state = "available"
}

resource "aws_subnet" "public" {
  count = 2
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 1}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]
  
  tags = {
    Name = "public-subnet-${count.index + 1}"
  }
}
```

### サブネットのタグ付け

サブネットにタグを付けます。

```hcl
resource "aws_subnet" "public" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"
  
  tags = {
    Name        = "public-subnet"
    Environment = "dev"
    Type        = "Public"
    ManagedBy   = "Terraform"
  }
}
```

## 2-4-3. インターネットゲートウェイ（IGW）

### IGWの作成とアタッチ

インターネットゲートウェイを作成してVPCにアタッチします。

```hcl
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id
  
  tags = {
    Name = "main-igw"
  }
}
```

### ルートテーブルへの追加

パブリックサブネットのルートテーブルにIGWへのルートを追加します。

```hcl
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id
  
  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }
  
  tags = {
    Name = "public-route-table"
  }
}

resource "aws_route_table_association" "public" {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}
```

### パブリックサブネットの設定

パブリックサブネットを完全に設定します。

```hcl
resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "ap-northeast-1a"
  map_public_ip_on_launch = true  # 自動的にパブリックIPを割り当て
}
```

## 2-4-4. NATゲートウェイ

### NATゲートウェイの作成

プライベートサブネットからインターネットにアクセスするためのNATゲートウェイを作成します。

```hcl
resource "aws_eip" "nat" {
  domain = "vpc"
  
  tags = {
    Name = "nat-eip"
  }
}

resource "aws_nat_gateway" "main" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public.id
  
  tags = {
    Name = "main-nat-gateway"
  }
  
  depends_on = [aws_internet_gateway.main]
}
```

### プライベートサブネットからのインターネット接続

プライベートサブネットのルートテーブルにNATゲートウェイへのルートを追加します。

```hcl
resource "aws_route_table" "private" {
  vpc_id = aws_vpc.main.id
  
  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main.id
  }
  
  tags = {
    Name = "private-route-table"
  }
}

resource "aws_route_table_association" "private" {
  subnet_id      = aws_subnet.private.id
  route_table_id = aws_route_table.private.id
}
```

### 高可用性の確保（複数AZ）

複数のアベイラビリティゾーンにNATゲートウェイを配置します。

```hcl
resource "aws_eip" "nat" {
  count  = 2
  domain = "vpc"
  
  tags = {
    Name = "nat-eip-${count.index + 1}"
  }
}

resource "aws_nat_gateway" "main" {
  count = 2
  
  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id
  
  tags = {
    Name = "nat-gateway-${count.index + 1}"
  }
}
```

### コスト最適化の考慮

NATゲートウェイは時間課金のため、使用しない時間帯は削除するなどの対策を検討します。

```hcl
# 開発環境ではNATインスタンスを使用する例
resource "aws_instance" "nat" {
  ami           = data.aws_ami.nat.id
  instance_type = "t3.micro"
  subnet_id     = aws_subnet.public.id
  
  source_dest_check = false
  
  tags = {
    Name = "nat-instance"
  }
}
```

## 2-4-5. セキュリティグループ

### セキュリティグループの基本作成

セキュリティグループを作成します。

```hcl
resource "aws_security_group" "web" {
  name        = "web-sg"
  description = "Webサーバー用のセキュリティグループ"
  vpc_id      = aws_vpc.main.id
  
  tags = {
    Name = "web-security-group"
  }
}
```

### インバウンドルールの設定

インバウンド（受信）ルールを設定します。

```hcl
resource "aws_security_group_rule" "web_http" {
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.web.id
}

resource "aws_security_group_rule" "web_https" {
  type              = "ingress"
  from_port         = 443
  to_port           = 443
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.web.id
}

resource "aws_security_group_rule" "web_ssh" {
  type              = "ingress"
  from_port         = 22
  to_port           = 22
  protocol          = "tcp"
  cidr_blocks       = ["10.0.0.0/16"]  # VPC内からのみ
  security_group_id = aws_security_group.web.id
}
```

### アウトバウンドルールの設定

アウトバウンド（送信）ルールを設定します。

```hcl
resource "aws_security_group_rule" "web_outbound" {
  type              = "egress"
  from_port         = 0
  to_port           = 0
  protocol          = "-1"  # 全てのプロトコル
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.web.id
}
```

### セキュリティグループ間の参照

他のセキュリティグループを参照します。

```hcl
resource "aws_security_group" "app" {
  name        = "app-sg"
  description = "アプリケーションサーバー用"
  vpc_id      = aws_vpc.main.id
}

resource "aws_security_group_rule" "app_from_web" {
  type                     = "ingress"
  from_port                = 8080
  to_port                  = 8080
  protocol                 = "tcp"
  source_security_group_id = aws_security_group.web.id
  security_group_id        = aws_security_group.app.id
}
```

### セキュリティグループの再利用

共通のセキュリティグループを再利用します。

```hcl
# 共通のセキュリティグループ
resource "aws_security_group" "common" {
  name        = "common-sg"
  description = "共通のセキュリティグループ"
  vpc_id      = aws_vpc.main.id
}

# 複数のリソースで使用
resource "aws_instance" "web1" {
  vpc_security_group_ids = [aws_security_group.common.id]
}

resource "aws_instance" "web2" {
  vpc_security_group_ids = [aws_security_group.common.id]
}
```

## 2-4-6. ネットワークACL

### ネットワークACLの作成

ネットワークACLを作成します。

```hcl
resource "aws_network_acl" "main" {
  vpc_id = aws_vpc.main.id
  
  tags = {
    Name = "main-nacl"
  }
}
```

### ルールの設定

ネットワークACLのルールを設定します。

```hcl
resource "aws_network_acl_rule" "allow_http" {
  network_acl_id = aws_network_acl.main.id
  rule_number    = 100
  protocol       = "tcp"
  rule_action    = "allow"
  cidr_block     = "0.0.0.0/0"
  from_port      = 80
  to_port        = 80
}

resource "aws_network_acl_rule" "deny_ssh" {
  network_acl_id = aws_network_acl.main.id
  rule_number    = 200
  protocol       = "tcp"
  rule_action    = "deny"
  cidr_block     = "0.0.0.0/0"
  from_port      = 22
  to_port        = 22
}
```

### セキュリティグループとの違い

| 特徴 | セキュリティグループ | ネットワークACL |
|------|---------------------|----------------|
| ステートフル | はい | いいえ |
| ルール数 | 最大60 | 最大20 |
| 適用範囲 | インスタンスレベル | サブネットレベル |
| デフォルト動作 | 全て拒否 | 全て許可 |

## 2-4-7. ルートテーブル

### ルートテーブルの作成

ルートテーブルを作成します。

```hcl
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id
  
  tags = {
    Name = "public-route-table"
  }
}
```

### ルートの追加

ルートを追加します。

```hcl
resource "aws_route" "public_internet" {
  route_table_id         = aws_route_table.public.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.main.id
}

resource "aws_route" "private_nat" {
  route_table_id         = aws_route_table.private.id
  destination_cidr_block = "0.0.0.0/0"
  nat_gateway_id         = aws_nat_gateway.main.id
}
```

### サブネットへの関連付け

サブネットにルートテーブルを関連付けます。

```hcl
resource "aws_route_table_association" "public" {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}
```

### デフォルトルートテーブル

VPCにはデフォルトのルートテーブルが作成されます。

```hcl
# デフォルトルートテーブルを取得
data "aws_route_table" "default" {
  vpc_id = aws_vpc.main.id
  filter {
    name   = "association.main"
    values = ["true"]
  }
}
```

## 2-4-8. VPCエンドポイント

### Gatewayエンドポイント（S3、DynamoDB）

S3やDynamoDBへのアクセスをVPC内で完結させるGatewayエンドポイントを作成します。

```hcl
resource "aws_vpc_endpoint" "s3" {
  vpc_id            = aws_vpc.main.id
  service_name      = "com.amazonaws.ap-northeast-1.s3"
  vpc_endpoint_type = "Gateway"
  
  route_table_ids = [
    aws_route_table.private.id
  ]
  
  tags = {
    Name = "s3-endpoint"
  }
}
```

### Interfaceエンドポイント

他のAWSサービスへのアクセス用のInterfaceエンドポイントを作成します。

```hcl
resource "aws_vpc_endpoint" "ecr" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.ap-northeast-1.ecr.api"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = [aws_subnet.private.id]
  security_group_ids  = [aws_security_group.vpc_endpoint.id]
  private_dns_enabled = true
  
  tags = {
    Name = "ecr-endpoint"
  }
}
```

### エンドポイントポリシー

エンドポイントポリシーを設定します。

```hcl
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.ap-northeast-1.s3"
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = "*"
        Action = [
          "s3:GetObject",
          "s3:PutObject"
        ]
        Resource = "*"
      }
    ]
  })
}
```

## 2-4-9. VPCピアリング

### VPCピアリング接続の作成

2つのVPC間でピアリング接続を作成します。

```hcl
resource "aws_vpc_peering_connection" "main_to_secondary" {
  vpc_id      = aws_vpc.main.id
  peer_vpc_id = aws_vpc.secondary.id
  auto_accept = true
  
  tags = {
    Name = "main-to-secondary-peering"
  }
}
```

### ルートテーブルの設定

ピアリング接続をルートテーブルに追加します。

```hcl
resource "aws_route" "peering" {
  route_table_id            = aws_route_table.main.id
  destination_cidr_block    = aws_vpc.secondary.cidr_block
  vpc_peering_connection_id = aws_vpc_peering_connection.main_to_secondary.id
}
```

### セキュリティグループの設定

ピアリング接続経由のトラフィックを許可するセキュリティグループルールを追加します。

```hcl
resource "aws_security_group_rule" "allow_peering" {
  type              = "ingress"
  from_port         = 0
  to_port           = 65535
  protocol          = "tcp"
  cidr_blocks       = [aws_vpc.secondary.cidr_block]
  security_group_id = aws_security_group.main.id
}
```

## 2-4-10. Transit Gateway

### Transit Gatewayの作成

複数のVPCを接続するTransit Gatewayを作成します。

```hcl
resource "aws_ec2_transit_gateway" "main" {
  description = "Main Transit Gateway"
  
  tags = {
    Name = "main-transit-gateway"
  }
}
```

### VPCアタッチメント

VPCをTransit Gatewayにアタッチします。

```hcl
resource "aws_ec2_transit_gateway_vpc_attachment" "main" {
  subnet_ids         = [aws_subnet.private.id]
  transit_gateway_id = aws_ec2_transit_gateway.main.id
  vpc_id             = aws_vpc.main.id
  
  tags = {
    Name = "main-vpc-attachment"
  }
}
```

### ルートテーブルの設定

Transit Gatewayのルートテーブルを設定します。

```hcl
resource "aws_ec2_transit_gateway_route_table" "main" {
  transit_gateway_id = aws_ec2_transit_gateway.main.id
  
  tags = {
    Name = "main-transit-gateway-route-table"
  }
}

resource "aws_ec2_transit_gateway_route_table_association" "main" {
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.main.id
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.main.id
}
```
