# 5-1. 高度な構文

Terraformの高度な構文とテクニックを説明します。

## 5-1-1. 条件分岐

### `count`による条件付きリソース作成

`count`を使用して条件付きでリソースを作成します。

```hcl
variable "create_instance" {
  type    = bool
  default = true
}

# create_instanceがtrueの場合のみインスタンスを作成
resource "aws_instance" "web" {
  count = var.create_instance ? 1 : 0
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t3.micro"
}

# 本番環境のみマルチAZを有効化
resource "aws_db_instance" "main" {
  multi_az = var.environment == "prod" ? true : false
  # ...
}
```

### `for_each`による条件付きリソース作成

`for_each`を使用して条件付きでリソースを作成します。

```hcl
variable "environments" {
  type = map(object({
    instance_type = string
    enabled       = bool
  }))
  default = {
    dev = {
      instance_type = "t3.micro"
      enabled       = true
    }
    staging = {
      instance_type = "t3.small"
      enabled       = true
    }
    prod = {
      instance_type = "t3.medium"
      enabled       = false
    }
  }
}

# enabledがtrueの環境のみリソースを作成
resource "aws_instance" "web" {
  for_each = {
    for k, v in var.environments : k => v
    if v.enabled
  }
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = each.value.instance_type
  
  tags = {
    Name        = "web-${each.key}"
    Environment = each.key
  }
}
```

### `count`と`for_each`の使い分け

| 特徴 | count | for_each |
|------|-------|----------|
| インデックス | 数値（0, 1, 2...） | キー（文字列） |
| 削除時の影響 | 中間要素の削除で再作成 | 影響なし |
| 用途 | 同じリソースの複数作成 | 異なる設定のリソース作成 |

```hcl
# count: 同じ設定のリソースを複数作成
resource "aws_instance" "web" {
  count = 3
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t3.micro"
  
  tags = {
    Name = "web-${count.index}"
  }
}

# for_each: 異なる設定のリソースを作成
resource "aws_instance" "web" {
  for_each = {
    dev  = "t3.micro"
    prod = "t3.medium"
  }
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = each.value
  
  tags = {
    Name = "web-${each.key}"
  }
}
```

### 三項演算子の活用

三項演算子を使用して条件分岐します。

```hcl
locals {
  # 環境に応じてインスタンスタイプを選択
  instance_type = var.environment == "prod" ? "t3.medium" : "t3.micro"
  
  # 本番環境のみバックアップを有効化
  backup_enabled = var.environment == "prod" ? true : false
  
  # 環境に応じてインスタンス数を決定
  instance_count = var.environment == "prod" ? 3 : 1
  
  # 複数条件の組み合わせ
  monitoring_enabled = var.environment == "prod" && var.enable_monitoring ? true : false
}
```

### `if`条件の実装

`for`式内で`if`を使用します。

```hcl
locals {
  # 本番環境のみを抽出
  prod_instances = [
    for instance in var.instances : instance
    if instance.environment == "prod"
  ]
  
  # 有効なリソースのみを抽出
  enabled_resources = {
    for k, v in var.resources : k => v
    if v.enabled
  }
  
  # 複数条件
  filtered_instances = [
    for instance in var.instances : instance
    if instance.environment == "prod" && instance.enabled
  ]
}
```

## 5-1-2. ループ処理

### `for`式の基本

`for`式を使用してリストやマップを変換します。

```hcl
locals {
  # リストの変換
  subnet_ids = [for subnet in aws_subnet.private : subnet.id]
  
  # マップの変換
  instance_ids = {
    for k, v in aws_instance.web : k => v.id
  }
  
  # リストからマップへの変換
  subnet_map = {
    for subnet in aws_subnet.private : subnet.availability_zone => subnet.id
  }
  
  # 値の変換
  uppercase_names = [for name in var.names : upper(name)]
}
```

### `for_each`でのループ

`for_each`を使用して複数のリソースを作成します。

```hcl
# リストからfor_each
variable "subnet_cidrs" {
  type = list(string)
  default = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
}

resource "aws_subnet" "private" {
  for_each = toset(var.subnet_cidrs)
  
  vpc_id     = aws_vpc.main.id
  cidr_block = each.value
  
  tags = {
    Name = "private-subnet-${each.key}"
  }
}

# マップからfor_each
variable "instances" {
  type = map(object({
    instance_type = string
    ami           = string
  }))
  default = {
    web = {
      instance_type = "t3.micro"
      ami           = "ami-123"
    }
    app = {
      instance_type = "t3.small"
      ami           = "ami-456"
    }
  }
}

resource "aws_instance" "main" {
  for_each = var.instances
  
  ami           = each.value.ami
  instance_type = each.value.instance_type
  
  tags = {
    Name = each.key
  }
}
```

### `count`でのループ

`count`を使用して複数のリソースを作成します。

```hcl
variable "instance_count" {
  type    = number
  default = 3
}

resource "aws_instance" "web" {
  count = var.instance_count
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t3.micro"
  
  tags = {
    Name = "web-${count.index + 1}"
  }
}

# countでリストの要素を使用
variable "availability_zones" {
  type    = list(string)
  default = ["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]
}

resource "aws_subnet" "public" {
  count = length(var.availability_zones)
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 1}.0/24"
  availability_zone = var.availability_zones[count.index]
  
  tags = {
    Name = "public-subnet-${count.index + 1}"
  }
}
```

### ネストされたループ

ネストされたループを実装します。

```hcl
locals {
  # 2次元配列を1次元配列に変換
  flattened = flatten([
    for env in var.environments : [
      for subnet in var.subnets : {
        env    = env
        subnet = subnet
      }
    ]
  ])
  
  # ネストされたマップの作成
  nested_map = {
    for env in var.environments : env => {
      for subnet in var.subnets : subnet => "${env}-${subnet}"
    }
  }
}
```

### ループでの条件分岐

ループ内で条件分岐を行います。

```hcl
locals {
  # 条件付きフィルタリング
  prod_subnets = [
    for subnet in var.subnets : subnet
    if subnet.environment == "prod"
  ]
  
  # 条件付き変換
  subnet_ids = [
    for subnet in var.subnets : 
    subnet.enabled ? subnet.id : null
  ]
  
  # nullを除外
  filtered_subnet_ids = compact([
    for subnet in var.subnets : 
    subnet.enabled ? subnet.id : null
  ])
}
```

## 5-1-3. 動的なリソース作成

### 動的なリソース名

動的にリソース名を生成します。

```hcl
locals {
  resource_prefix = "${var.project_name}-${var.environment}"
}

resource "aws_s3_bucket" "main" {
  bucket = "${local.resource_prefix}-bucket-${random_id.suffix.hex}"
  
  tags = {
    Name = "${local.resource_prefix}-bucket"
  }
}

resource "random_id" "suffix" {
  byte_length = 4
}
```

### 動的な属性値

動的に属性値を設定します。

```hcl
variable "security_group_rules" {
  type = list(object({
    from_port   = number
    to_port     = number
    protocol    = string
    cidr_blocks = list(string)
  }))
  default = [
    {
      from_port   = 80
      to_port     = 80
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    },
    {
      from_port   = 443
      to_port     = 443
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    }
  ]
}

resource "aws_security_group" "web" {
  name   = "web-sg"
  vpc_id = aws_vpc.main.id
  
  dynamic "ingress" {
    for_each = var.security_group_rules
    content {
      from_port   = ingress.value.from_port
      to_port     = ingress.value.to_port
      protocol    = ingress.value.protocol
      cidr_blocks = ingress.value.cidr_blocks
    }
  }
}
```

### マップとリストの活用

マップとリストを活用して動的にリソースを作成します。

```hcl
variable "instances" {
  type = map(object({
    instance_type = string
    subnet_id     = string
    tags          = map(string)
  }))
}

resource "aws_instance" "main" {
  for_each = var.instances
  
  ami           = data.aws_ami.amazon_linux.id
  instance_type = each.value.instance_type
  subnet_id     = each.value.subnet_id
  
  tags = merge(
    each.value.tags,
    {
      Name = each.key
    }
  )
}
```

### 変数の動的な組み合わせ

変数を動的に組み合わせます。

```hcl
locals {
  # 環境とリージョンの組み合わせ
  env_region_combinations = flatten([
    for env in var.environments : [
      for region in var.regions : {
        env    = env
        region = region
        name   = "${env}-${region}"
      }
    ]
  ])
  
  # マップに変換
  env_region_map = {
    for combo in local.env_region_combinations :
    combo.name => combo
  }
}
```

## 5-1-4. localsの活用

### 複雑な計算式の簡略化

複雑な計算をlocalsで簡略化します。

```hcl
locals {
  # サブネットのCIDR計算
  subnet_cidrs = [
    for i in range(var.subnet_count) :
    cidrsubnet(var.vpc_cidr, 8, i)
  ]
  
  # タグの統合
  common_tags = merge(
    var.tags,
    {
      Project     = var.project_name
      Environment = var.environment
      ManagedBy   = "Terraform"
      CreatedAt   = timestamp()
    }
  )
  
  # 複雑な条件分岐
  instance_config = {
    dev = {
      instance_type = "t3.micro"
      min_size      = 1
      max_size      = 2
    }
    staging = {
      instance_type = "t3.small"
      min_size      = 2
      max_size      = 4
    }
    prod = {
      instance_type = "t3.medium"
      min_size      = 3
      max_size      = 10
    }
  }[var.environment]
}
```

### 繰り返し使用する値の定義

繰り返し使用する値をlocalsで定義します。

```hcl
locals {
  # 共通のプレフィックス
  name_prefix = "${var.project_name}-${var.environment}"
  
  # 共通のタグ
  common_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = "Terraform"
  }
  
  # リソース名
  vpc_name     = "${local.name_prefix}-vpc"
  subnet_name  = "${local.name_prefix}-subnet"
  sg_name      = "${local.name_prefix}-sg"
}

resource "aws_vpc" "main" {
  cidr_block = var.vpc_cidr
  tags       = merge(local.common_tags, { Name = local.vpc_name })
}
```

### localsでの条件分岐

localsで条件分岐を行います。

```hcl
locals {
  # 環境に応じた設定
  is_production = var.environment == "prod"
  
  instance_type = local.is_production ? "t3.medium" : "t3.micro"
  multi_az      = local.is_production ? true : false
  backup_enabled = local.is_production ? true : false
  
  # 複数条件
  monitoring_enabled = local.is_production && var.enable_monitoring
  
  # 複雑な条件分岐
  instance_count = (
    var.environment == "prod" ? 5 :
    var.environment == "staging" ? 2 :
    1
  )
}
```

### localsでのループ処理

localsでループ処理を行います。

```hcl
locals {
  # リストの変換
  uppercase_names = [for name in var.names : upper(name)]
  
  # マップの変換
  instance_ids = {
    for k, v in aws_instance.web : k => v.id
  }
  
  # フィルタリング
  enabled_instances = {
    for k, v in var.instances : k => v
    if v.enabled
  }
  
  # 複雑な変換
  subnet_configs = [
    for i, az in var.availability_zones : {
      cidr_block        = cidrsubnet(var.vpc_cidr, 8, i)
      availability_zone = az
      name              = "${var.environment}-subnet-${i + 1}"
    }
  ]
}
```

## 5-1-5. 関数の活用

### 文字列関数（`join`、`split`、`replace`など）

```hcl
locals {
  # join: リストを文字列に結合
  subnet_ids_string = join(",", aws_subnet.private[*].id)
  
  # split: 文字列をリストに分割
  cidr_parts = split(".", var.vpc_cidr)
  
  # replace: 文字列を置換
  sanitized_name = replace(var.resource_name, "_", "-")
  
  # upper/lower: 大文字/小文字に変換
  uppercase_env = upper(var.environment)
  lowercase_env = lower(var.environment)
  
  # format: 文字列のフォーマット
  formatted_name = format("%s-%s-%03d", var.project, var.environment, var.index)
  
  # substr: 部分文字列の取得
  short_id = substr(var.resource_id, 0, 8)
  
  # trim: 空白の削除
  trimmed_name = trim(var.resource_name)
}
```

### 数値関数（`max`、`min`、`abs`など）

```hcl
locals {
  # max: 最大値
  max_instance_count = max(var.min_size, var.desired_size, var.max_size)
  
  # min: 最小値
  min_instance_count = min(var.min_size, var.desired_size)
  
  # abs: 絶対値
  absolute_value = abs(var.number)
  
  # ceil: 切り上げ
  rounded_up = ceil(var.decimal_number)
  
  # floor: 切り捨て
  rounded_down = floor(var.decimal_number)
  
  # pow: べき乗
  power_of_two = pow(2, var.exponent)
}
```

### コレクション関数（`keys`、`values`、`merge`など）

```hcl
locals {
  # keys: マップのキーを取得
  environment_names = keys(var.environments)
  
  # values: マップの値を取得
  instance_types = values(var.environments)
  
  # merge: マップをマージ
  all_tags = merge(
    var.common_tags,
    var.environment_tags,
    { Name = var.resource_name }
  )
  
  # concat: リストを結合
  all_subnets = concat(
    aws_subnet.public[*].id,
    aws_subnet.private[*].id
  )
  
  # flatten: ネストされたリストを平坦化
  flattened_list = flatten([
    var.list1,
    var.list2,
    [var.list3]
  ])
  
  # distinct: 重複を削除
  unique_values = distinct(var.list_with_duplicates)
  
  # contains: 要素が含まれるか確認
  has_prod = contains(var.environments, "prod")
  
  # length: 長さを取得
  subnet_count = length(var.subnets)
  
  # lookup: マップから値を取得
  instance_type = lookup(var.instance_types, var.environment, "t3.micro")
}
```

### 日付・時刻関数

```hcl
locals {
  # timestamp: 現在のタイムスタンプ
  current_time = timestamp()
  
  # formatdate: 日付のフォーマット
  formatted_date = formatdate("YYYY-MM-DD", timestamp())
  formatted_time = formatdate("hh:mm:ss", timestamp())
  
  # タイムスタンプをタグに使用
  creation_time = formatdate("YYYY-MM-DD'T'hh:mm:ssZ", timestamp())
}

resource "aws_s3_bucket" "backup" {
  bucket = "backup-${formatdate("YYYYMMDD", timestamp())}"
}
```

### 暗号化関数

```hcl
locals {
  # base64encode: Base64エンコード
  encoded_data = base64encode(var.user_data)
  
  # base64decode: Base64デコード
  decoded_data = base64decode(var.encoded_data)
  
  # md5: MD5ハッシュ
  file_hash = md5(file("${path.module}/script.sh"))
  
  # sha256: SHA256ハッシュ
  secure_hash = sha256(var.sensitive_data)
  
  # filemd5: ファイルのMD5ハッシュ
  script_hash = filemd5("${path.module}/init.sh")
}
```

### 型変換関数

```hcl
locals {
  # tostring: 文字列に変換
  port_string = tostring(var.port_number)
  
  # tonumber: 数値に変換
  port_number = tonumber(var.port_string)
  
  # tobool: 真偽値に変換
  is_enabled = tobool(var.enabled_string)
  
  # tolist: リストに変換
  subnet_list = tolist(var.subnet_set)
  
  # toset: セットに変換
  subnet_set = toset(var.subnet_list)
  
  # tomap: マップに変換
  tag_map = tomap(var.tags)
}
```

## 5-1-6. テンプレート

### `templatefile()`関数

テンプレートファイルを読み込んで変数を展開します。

```hcl
# templates/user_data.sh.tpl
#!/bin/bash
yum update -y
yum install -y ${package_name}

echo "Environment: ${environment}" > /etc/environment
echo "Database Host: ${db_host}" >> /etc/environment

# main.tf
resource "aws_instance" "web" {
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t3.micro"
  
  user_data = templatefile("${path.module}/templates/user_data.sh.tpl", {
    package_name = "httpd"
    environment  = var.environment
    db_host      = aws_db_instance.main.endpoint
  })
}
```

### テンプレート変数

テンプレート内で変数を使用します。

```hcl
# templates/nginx.conf.tpl
server {
    listen ${port};
    server_name ${server_name};
    root ${document_root};
    
    location / {
        proxy_pass http://${backend_host}:${backend_port};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# main.tf
resource "aws_instance" "web" {
  user_data = templatefile("${path.module}/templates/nginx.conf.tpl", {
    port          = 80
    server_name   = "example.com"
    document_root = "/var/www/html"
    backend_host  = aws_instance.app.private_ip
    backend_port  = 8080
  })
}
```

### 条件付きテンプレート

テンプレート内で条件分岐を使用します。

```hcl
# templates/config.yaml.tpl
environment: ${environment}
debug: ${debug_mode}

%{ if enable_monitoring ~}
monitoring:
  enabled: true
  endpoint: ${monitoring_endpoint}
%{ endif ~}

%{ if environment == "prod" ~}
replicas: 3
resources:
  cpu: 2
  memory: 4Gi
%{ else ~}
replicas: 1
resources:
  cpu: 1
  memory: 2Gi
%{ endif ~}

# main.tf
locals {
  config = templatefile("${path.module}/templates/config.yaml.tpl", {
    environment         = var.environment
    debug_mode          = var.environment != "prod"
    enable_monitoring   = var.enable_monitoring
    monitoring_endpoint = var.monitoring_endpoint
  })
}
```
