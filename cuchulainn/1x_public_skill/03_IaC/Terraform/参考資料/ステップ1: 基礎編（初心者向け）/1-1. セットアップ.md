# 1-1. セットアップ

Terraformを使用するための環境構築手順を説明します。

## 1-1-1. Terraformのインストール

### macOSでのインストール（Homebrew）

Homebrewを使用してインストールする方法です。

```bash
# Homebrewでインストール
brew install terraform

# バージョン確認
terraform version
```

### Linuxでのインストール（パッケージマネージャー）

#### Ubuntu/Debian

```bash
# HashiCorpのGPGキーを追加
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -

# HashiCorpのリポジトリを追加
sudo apt-add-repository "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com $(lsb_release -cs) main"

# インストール
sudo apt update
sudo apt install terraform
```

#### CentOS/RHEL

```bash
# HashiCorpのリポジトリを追加
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo

# インストール
sudo yum install terraform
```

### Windowsでのインストール

#### Chocolateyを使用

```powershell
choco install terraform
```

#### Scoopを使用

```powershell
scoop install terraform
```

### 手動インストール（バイナリダウンロード）

1. [Terraform公式サイト](https://www.terraform.io/downloads)からバイナリをダウンロード
2. 解凍してPATHが通っているディレクトリに配置

```bash
# Linux/macOSの場合
wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
unzip terraform_1.6.0_linux_amd64.zip
sudo mv terraform /usr/local/bin/
```

### バージョン管理（tfenv、tfswitch）

複数のTerraformバージョンを管理するツールです。

#### tfenv（macOS/Linux）

```bash
# tfenvのインストール
brew install tfenv  # macOS
# または
git clone https://github.com/tfutils/tfenv.git ~/.tfenv

# バージョンのインストール
tfenv install 1.6.0

# 使用するバージョンの指定
tfenv use 1.6.0

# バージョン一覧
tfenv list
```

#### tfswitch（クロスプラットフォーム）

```bash
# tfswitchのインストール
brew install warrensbox/tap/tfswitch  # macOS

# バージョンのインストールと切り替え
tfswitch 1.6.0

# .terraform-versionファイルで自動切り替え
echo "1.6.0" > .terraform-version
```

### 複数バージョンの管理方法

プロジェクトごとに異なるバージョンを使用する場合：

1. `.terraform-version`ファイルをプロジェクトルートに配置
2. tfenvやtfswitchが自動的にバージョンを切り替え

```bash
# .terraform-versionファイルの例
1.6.0
```

## 1-1-2. AWS CLIの設定

### AWS CLIのインストール

#### macOS

```bash
brew install awscli
```

#### Linux

```bash
# pipを使用
pip3 install awscli

# または公式インストーラー
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

#### Windows

```powershell
# Chocolatey
choco install awscli

# またはMSIインストーラーをダウンロード
```

### `aws configure`の実行

基本的な認証情報とリージョンを設定します。

```bash
aws configure
```

対話形式で以下を入力：
- AWS Access Key ID
- AWS Secret Access Key
- Default region name（例: `ap-northeast-1`）
- Default output format（例: `json`）

### アクセスキーとシークレットキーの設定

IAMユーザーからアクセスキーを取得して設定します。

```bash
# 直接設定
aws configure set aws_access_key_id YOUR_ACCESS_KEY
aws configure set aws_secret_access_key YOUR_SECRET_KEY
```

### リージョンの設定

```bash
# デフォルトリージョンの設定
aws configure set region ap-northeast-1

# 環境変数で設定
export AWS_DEFAULT_REGION=ap-northeast-1
```

### プロファイルの作成と切り替え

複数のAWSアカウントや環境を管理する場合に便利です。

```bash
# プロファイルの作成
aws configure --profile dev
aws configure --profile prod

# プロファイルの使用
aws s3 ls --profile dev
aws s3 ls --profile prod

# 環境変数でプロファイルを指定
export AWS_PROFILE=dev
```

### 環境変数での認証情報設定

環境変数で認証情報を設定する方法です。

```bash
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=ap-northeast-1
```

### IAMロールの利用方法

EC2インスタンスなどでIAMロールを使用する場合、追加の設定は不要です。Terraformからも自動的にロールが使用されます。

## 1-1-3. 基本的な環境構築

### 作業ディレクトリの作成

プロジェクト用のディレクトリを作成します。

```bash
mkdir terraform-project
cd terraform-project
```

### 初めての`.tf`ファイル作成

最初のTerraformファイルを作成します。

```hcl
# main.tf
terraform {
  required_version = ">= 1.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "ap-northeast-1"
}

# サンプルリソース（S3バケット）
resource "aws_s3_bucket" "example" {
  bucket = "my-terraform-test-bucket-12345"
  
  tags = {
    Name        = "My bucket"
    Environment = "Dev"
  }
}
```

### エディタの設定（VSCode拡張機能など）

#### VSCode拡張機能

1. **HashiCorp Terraform**拡張機能をインストール
   - シンタックスハイライト
   - 自動補完
   - フォーマット機能

2. **Terraform**拡張機能（Anton Kulikov版）
   - 追加の機能とサポート

### シンタックスハイライトの設定

VSCodeでは、拡張機能をインストールするだけで自動的に有効になります。

### 自動フォーマットの設定

VSCodeの設定（`settings.json`）に以下を追加：

```json
{
  "[terraform]": {
    "editor.defaultFormatter": "hashicorp.terraform",
    "editor.formatOnSave": true
  }
}
```

## 1-1-4. 開発環境の整備

### Gitリポジトリの初期化

バージョン管理を開始します。

```bash
git init
git add .
git commit -m "Initial commit"
```

### `.gitignore`の設定

Terraformプロジェクト用の`.gitignore`を作成します。

```gitignore
# Local .terraform directories
**/.terraform/*

# .tfstate files
*.tfstate
*.tfstate.*

# Crash log files
crash.log
crash.*.log

# Exclude all .tfvars files, which are likely to contain sensitive data
*.tfvars
*.tfvars.json

# Ignore override files
override.tf
override.tf.json
*_override.tf
*_override.tf.json

# Ignore CLI configuration files
.terraformrc
terraform.rc

# Ignore Mac .DS_Store files
.DS_Store
```

### ディレクトリ構造の理解

基本的なディレクトリ構造：

```
terraform-project/
├── main.tf          # メインのリソース定義
├── variables.tf     # 変数定義
├── outputs.tf      # 出力値定義
├── terraform.tfvars # 変数の値（gitignoreに追加推奨）
└── .terraform/     # プロバイダーのキャッシュ（gitignoreに追加）
```

### 環境変数の管理方法

#### `.env`ファイルの使用（direnvなど）

```bash
# direnvのインストール
brew install direnv  # macOS

# .envrcファイルを作成
echo 'export AWS_PROFILE=dev' > .envrc
echo 'export AWS_DEFAULT_REGION=ap-northeast-1' >> .envrc

# 許可
direnv allow
```

#### 環境変数の設定例

```bash
# Terraform用の環境変数
export TF_VAR_region=ap-northeast-1
export TF_VAR_environment=dev

# AWS認証情報
export AWS_PROFILE=dev
export AWS_DEFAULT_REGION=ap-northeast-1
```
