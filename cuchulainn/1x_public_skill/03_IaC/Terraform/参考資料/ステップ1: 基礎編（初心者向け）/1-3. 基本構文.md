# 1-3. 基本構文

Terraformの基本的な構文と書き方を説明します。

## 1-3-1. リソースの定義

### `resource`ブロックの基本構文

リソースを定義する基本的な構文です。

```hcl
resource "リソースタイプ" "リソース名" {
  # 属性の設定
}
```

例：

```hcl
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket-12345"
  
  tags = {
    Name = "Example Bucket"
  }
}
```

### リソースタイプとリソース名

- **リソースタイプ**: `aws_s3_bucket`のように、プロバイダー名とリソース名を組み合わせた形式
- **リソース名**: `example`のように、同じファイル内で一意の識別子

### リソース属性の設定

リソースの属性を設定します。

```hcl
resource "aws_instance" "web" {
  ami           = "ami-0c3fd0f5d33134a76"
  instance_type = "t3.micro"
  
  tags = {
    Name = "Web Server"
  }
}
```

### 必須属性とオプション属性

- **必須属性**: リソース作成に必要な属性（例: S3バケットの`bucket`）
- **オプション属性**: 省略可能な属性（例: `tags`）

### リソースの命名規則

- 小文字とアンダースコアを使用
- 意味のある名前を付ける
- 例: `web_server`, `database_instance`, `vpc_main`

### リソースの依存関係

Terraformは自動的に依存関係を検出しますが、明示的に指定することもできます。

```hcl
# 自動的な依存関係（参照による）
resource "aws_security_group" "web" {
  name = "web-sg"
}

resource "aws_instance" "web" {
  ami           = "ami-0c3fd0f5d33134a76"
  instance_type = "t3.micro"
  security_groups = [aws_security_group.web.id]  # 依存関係が自動検出
}

# 明示的な依存関係
resource "aws_instance" "web" {
  # ...
  
  depends_on = [aws_security_group.web]
}
```

## 1-3-2. プロバイダーの設定

### `provider`ブロックの書き方

プロバイダーを設定します。

```hcl
provider "aws" {
  region = "ap-northeast-1"
}
```

### AWSプロバイダーの設定

```hcl
provider "aws" {
  region     = "ap-northeast-1"
  access_key = var.aws_access_key
  secret_key = var.aws_secret_key
}
```

### リージョンの指定

```hcl
provider "aws" {
  region = "ap-northeast-1"
}

# 複数リージョンを使用する場合
provider "aws" {
  alias  = "tokyo"
  region = "ap-northeast-1"
}

provider "aws" {
  alias  = "osaka"
  region = "ap-northeast-3"
}
```

### 認証情報の設定方法

#### 環境変数（推奨）

```bash
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
```

#### プロファイル

```hcl
provider "aws" {
  region  = "ap-northeast-1"
  profile = "dev"
}
```

#### 直接指定（非推奨）

```hcl
provider "aws" {
  access_key = "your_access_key"
  secret_key = "your_secret_key"
}
```

### 複数プロバイダーの利用

```hcl
provider "aws" {
  alias  = "primary"
  region = "ap-northeast-1"
}

provider "aws" {
  alias  = "secondary"
  region = "us-east-1"
}

resource "aws_s3_bucket" "primary" {
  provider = aws.primary
  bucket   = "primary-bucket"
}

resource "aws_s3_bucket" "secondary" {
  provider = aws.secondary
  bucket   = "secondary-bucket"
}
```

### プロバイダーのバージョン指定

```hcl
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"  # 5.0以上5.1未満
    }
  }
}
```

バージョン指定の例：
- `">= 4.0"`: 4.0以上
- `"~> 4.0"`: 4.0以上5.0未満
- `"= 4.0"`: 正確に4.0

## 1-3-3. 変数（variable）の使い方

### `variable`ブロックの基本

変数を定義します。

```hcl
variable "instance_type" {
  type        = string
  description = "EC2インスタンスタイプ"
  default     = "t3.micro"
}
```

### 変数の型（string、number、bool、list、map）

```hcl
# 文字列
variable "name" {
  type = string
}

# 数値
variable "count" {
  type = number
}

# 真偽値
variable "enabled" {
  type = bool
}

# リスト
variable "availability_zones" {
  type = list(string)
}

# マップ
variable "tags" {
  type = map(string)
}

# オブジェクト
variable "config" {
  type = object({
    name = string
    age  = number
  })
}
```

### デフォルト値の設定

```hcl
variable "instance_type" {
  type    = string
  default = "t3.micro"
}
```

### 変数の説明（description）

```hcl
variable "bucket_name" {
  type        = string
  description = "S3バケット名（グローバルで一意である必要があります）"
}
```

### 変数の検証（validation）

```hcl
variable "instance_type" {
  type = string
  
  validation {
    condition     = can(regex("^t[23]", var.instance_type))
    error_message = "インスタンスタイプはt2またはt3で始まる必要があります。"
  }
}
```

### 変数の参照方法（`var.変数名`）

```hcl
resource "aws_instance" "example" {
  ami           = "ami-0c3fd0f5d33134a76"
  instance_type = var.instance_type
}
```

### 環境変数での変数指定（`TF_VAR_`）

環境変数で変数を指定する場合、`TF_VAR_`プレフィックスを使用します。

```bash
export TF_VAR_instance_type=t3.small
export TF_VAR_region=ap-northeast-1
```

## 1-3-4. 出力（output）の使い方

### `output`ブロックの基本

出力値を定義します。

```hcl
output "bucket_name" {
  value = aws_s3_bucket.example.bucket
}
```

### 出力値の定義

```hcl
output "instance_id" {
  value       = aws_instance.web.id
  description = "EC2インスタンスのID"
}
```

### 出力値の参照

他のモジュールやリソースから参照できます。

```hcl
# モジュール内
output "vpc_id" {
  value = aws_vpc.main.id
}

# モジュール呼び出し側
module "network" {
  source = "./modules/network"
}

resource "aws_instance" "web" {
  subnet_id = module.network.vpc_id
}
```

### 出力値の表示方法

```bash
# 全ての出力値を表示
terraform output

# 特定の出力値を表示
terraform output bucket_name

# JSON形式で表示
terraform output -json
```

### 機密情報の非表示（`sensitive = true`）

```hcl
output "db_password" {
  value     = aws_db_instance.example.password
  sensitive = true
}
```

`sensitive = true`を設定すると、`terraform output`で表示されません。

### 依存関係の明示（`depends_on`）

```hcl
output "bucket_arn" {
  value     = aws_s3_bucket.example.arn
  depends_on = [aws_s3_bucket.example]
}
```

## 1-3-5. データソース（data）の使い方

### `data`ブロックの基本

既存のリソースを参照します。

```hcl
data "aws_vpc" "default" {
  default = true
}
```

### 既存リソースの参照

```hcl
# 既存のVPCを参照
data "aws_vpc" "existing" {
  id = "vpc-12345678"
}

# 参照したVPCを使用
resource "aws_subnet" "example" {
  vpc_id     = data.aws_vpc.existing.id
  cidr_block = "10.0.1.0/24"
}
```

### データソースの種類

- `aws_vpc`: VPC情報
- `aws_ami`: AMI情報
- `aws_availability_zones`: アベイラビリティゾーン一覧
- `aws_caller_identity`: 現在のAWSアカウント情報

### データソースのフィルタリング

```hcl
# 最新のAMIを取得
data "aws_ami" "amazon_linux" {
  most_recent = true
  owners      = ["amazon"]
  
  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-gp2"]
  }
}
```

### データソースの依存関係

データソースは、参照されるリソースが存在することを前提とします。

## 1-3-6. localsの活用

### `locals`ブロックの基本

ローカル変数を定義します。

```hcl
locals {
  common_tags = {
    Environment = "dev"
    Project     = "my-project"
  }
}
```

### ローカル変数の定義

```hcl
locals {
  instance_name = "web-server-${var.environment}"
  bucket_name   = "${var.project_name}-${random_id.bucket_suffix.hex}"
}
```

### 計算式の使用

```hcl
locals {
  subnet_count = length(var.availability_zones)
  cidr_blocks  = [for i in range(local.subnet_count) : cidrsubnet(var.vpc_cidr, 8, i)]
}
```

### 複雑な値の簡略化

```hcl
locals {
  # 複雑な設定を簡略化
  instance_config = {
    ami           = var.ami_id
    instance_type = var.instance_type
    tags          = merge(var.common_tags, { Name = var.instance_name })
  }
}

resource "aws_instance" "example" {
  ami           = local.instance_config.ami
  instance_type = local.instance_config.instance_type
  tags          = local.instance_config.tags
}
```

### localsとvariableの使い分け

- **variable**: 外部から値を注入する場合
- **locals**: 内部での計算や値の組み合わせに使用

## 1-3-7. ファイルの読み込み

### `file()`関数の使い方

ファイルの内容を読み込みます。

```hcl
resource "aws_instance" "web" {
  user_data = file("${path.module}/scripts/user-data.sh")
}
```

### テンプレートファイルの読み込み

`templatefile()`関数を使用します。

```hcl
# user-data.tpl
#!/bin/bash
echo "Hello, ${name}!"

# main.tf
resource "aws_instance" "web" {
  user_data = templatefile("${path.module}/user-data.tpl", {
    name = "World"
  })
}
```

### 外部ファイルの参照方法

```hcl
# 相対パス
file("scripts/init.sh")

# モジュールパス
file("${path.module}/scripts/init.sh")

# ルートパス
file("${path.root}/common/scripts/init.sh")
```

## 1-3-8. コメントの書き方

### 単行コメント（`#`）

```hcl
# これは単行コメントです
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"  # インラインコメント
}
```

### 複数行コメント（`/* */`）

```hcl
/*
これは複数行コメントです。
複数行にわたってコメントを書くことができます。
*/

resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
}
```

### ドキュメントコメントのベストプラクティス

- リソースの目的を説明
- 複雑なロジックには説明を追加
- TODOやFIXMEを明記

```hcl
# Webサーバー用のEC2インスタンス
# パブリックサブネットに配置し、ALBからアクセス可能
resource "aws_instance" "web" {
  # TODO: より大きなインスタンスタイプに変更を検討
  instance_type = "t3.micro"
  
  # セキュリティグループは別途定義
  vpc_security_group_ids = [aws_security_group.web.id]
}
```
