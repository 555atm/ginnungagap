# 1-2. 基本操作

Terraformの基本的なコマンドと操作方法を説明します。

## 1-2-1. terraform init

### 初期化コマンドの基本

プロジェクトを初期化し、プロバイダーをダウンロードします。

```bash
terraform init
```

実行すると：
- プロバイダーのダウンロード
- バックエンドの初期化
- `.terraform`ディレクトリの作成

### プロバイダーのダウンロード

`required_providers`ブロックで指定したプロバイダーが自動的にダウンロードされます。

```hcl
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

### バックエンドの初期化

リモートバックエンドを使用する場合、`init`時に設定されます。

```hcl
terraform {
  backend "s3" {
    bucket = "my-terraform-state"
    key    = "path/to/terraform.tfstate"
    region = "ap-northeast-1"
  }
}
```

### `.terraform`ディレクトリの理解

`.terraform`ディレクトリには以下が保存されます：
- プロバイダーのバイナリ
- モジュールのキャッシュ
- バックエンド設定

このディレクトリは`.gitignore`に追加することを推奨します。

### エラーと対処法

#### プロバイダーのダウンロードエラー

```bash
# キャッシュをクリアして再試行
rm -rf .terraform
terraform init
```

#### バックエンドの設定エラー

バックエンドの設定が間違っている場合、エラーメッセージを確認して修正します。

## 1-2-2. terraform plan

### 変更点の確認方法

実行計画を確認します。実際のリソースは作成されません。

```bash
terraform plan
```

### plan出力の読み方

```
Terraform will perform the following actions:

  # aws_s3_bucket.example will be created
  + resource "aws_s3_bucket" "example" {
      + bucket = "my-bucket-12345"
      + id     = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

- `+`: 作成されるリソース
- `-`: 削除されるリソース
- `~`: 変更されるリソース
- `-/+`: 置き換えられるリソース

### `-out`オプションの使い方

プランをファイルに保存します。

```bash
terraform plan -out=tfplan
terraform apply tfplan
```

### `-var`オプションでの変数指定

コマンドラインで変数を指定します。

```bash
terraform plan -var="region=ap-northeast-1" -var="environment=dev"
```

### `-var-file`オプションの使い方

変数ファイルを指定します。

```bash
terraform plan -var-file="dev.tfvars"
```

### `-target`オプションでの部分適用

特定のリソースのみを対象にします。

```bash
terraform plan -target=aws_s3_bucket.example
```

### planの保存と確認

```bash
# プランを保存
terraform plan -out=plan.out

# 保存したプランを確認
terraform show plan.out
```

## 1-2-3. terraform apply

### 変更の反映方法

プランを実行してリソースを作成・更新します。

```bash
terraform apply
```

### 対話的な確認

デフォルトでは、適用前に確認を求められます。

```
Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

### `-auto-approve`オプション

確認をスキップして自動的に適用します。

```bash
terraform apply -auto-approve
```

### `-var`と`-var-file`の指定

planと同様に変数を指定できます。

```bash
terraform apply -var="region=ap-northeast-1"
terraform apply -var-file="prod.tfvars"
```

### エラー時の対処法

#### リソース作成エラー

エラーメッセージを確認し、設定を修正して再実行します。

```bash
# エラーが発生した場合
# 1. エラーメッセージを確認
# 2. 設定を修正
# 3. terraform planで再確認
# 4. terraform applyで再実行
```

#### タイムアウトエラー

リソースの作成に時間がかかる場合、タイムアウトを調整します。

### ロールバックの方法

#### 手動でのロールバック

```bash
# 前の状態に戻す
terraform apply -refresh=false

# または、特定のリソースを削除
terraform destroy -target=aws_s3_bucket.example
```

#### ステートファイルからの復元

```bash
# バックアップから復元
cp terraform.tfstate.backup terraform.tfstate
terraform refresh
```

## 1-2-4. terraform destroy

### リソースの削除方法

全てのリソースを削除します。

```bash
terraform destroy
```

### 部分的な削除（`-target`オプション）

特定のリソースのみを削除します。

```bash
terraform destroy -target=aws_s3_bucket.example
```

### 削除の確認方法

削除前に確認が求められます。

```
Do you want to destroy all resources?
  Terraform will destroy all your managed infrastructure.
  Only 'yes' will be accepted to confirm.

  Enter a value: yes
```

### 削除できないリソースの対処

#### 依存関係があるリソース

依存関係を確認して、順番に削除します。

```bash
# 依存関係を確認
terraform graph | dot -Tsvg > graph.svg

# 順番に削除
terraform destroy -target=aws_instance.example
terraform destroy -target=aws_security_group.example
```

#### 保護されているリソース

リソースに`prevent_destroy = true`が設定されている場合、先に設定を変更します。

## 1-2-5. terraform fmt

### コードの自動整形

Terraformファイルを自動的に整形します。

```bash
terraform fmt
```

### 再帰的な整形（`-recursive`）

サブディレクトリも含めて整形します。

```bash
terraform fmt -recursive
```

### 差分の確認（`-check`）

整形が必要かどうかを確認します（CI/CDで使用）。

```bash
terraform fmt -check
```

### CI/CDでの活用

GitHub Actionsの例：

```yaml
- name: Terraform Format Check
  run: terraform fmt -check
```

## 1-2-6. terraform validate

### 構文チェックの実行

Terraformファイルの構文をチェックします。

```bash
terraform validate
```

### バリデーションエラーの読み方

```
Error: Missing required argument

  on main.tf line 5:
   5: resource "aws_s3_bucket" "example" {

The argument "bucket" is required, but no definition was found.
```

エラーメッセージから、問題のあるファイルと行番号を確認できます。

### 変数の型チェック

変数の型が正しいかチェックします。

```hcl
variable "count" {
  type = number
  # 文字列を指定するとエラー
}
```

### リソース参照の検証

存在しないリソースを参照している場合、エラーが表示されます。

## 1-2-7. その他のコマンド

### `terraform show` - ステートの表示

現在のステートを表示します。

```bash
# 全体を表示
terraform show

# 特定のリソースを表示
terraform show aws_s3_bucket.example

# JSON形式で表示
terraform show -json
```

### `terraform state` - ステート操作

ステートファイルを操作します。

```bash
# ステートの一覧表示
terraform state list

# 特定のリソースの詳細表示
terraform state show aws_s3_bucket.example

# リソースの移動（リネーム）
terraform state mv aws_s3_bucket.old aws_s3_bucket.new

# リソースの削除（ステートから）
terraform state rm aws_s3_bucket.example
```

### `terraform output` - 出力値の表示

定義した出力値を表示します。

```bash
# 全ての出力値を表示
terraform output

# 特定の出力値を表示
terraform output bucket_name

# JSON形式で表示
terraform output -json
```

### `terraform refresh` - ステートの更新

実際のリソースの状態を確認してステートを更新します。

```bash
terraform refresh
```

注意: リソースの変更は行われません。

### `terraform graph` - 依存関係の可視化

リソース間の依存関係を可視化します。

```bash
# グラフを出力
terraform graph | dot -Tsvg > graph.svg

# テキスト形式で表示
terraform graph
```

### `terraform version` - バージョン確認

Terraformのバージョンを確認します。

```bash
terraform version
```

出力例：
```
Terraform v1.6.0
on darwin_amd64
```

### `terraform workspace` - ワークスペース操作

ワークスペースを管理します。

```bash
# ワークスペース一覧
terraform workspace list

# 新しいワークスペースを作成
terraform workspace new dev

# ワークスペースを切り替え
terraform workspace select dev

# 現在のワークスペースを確認
terraform workspace show

# ワークスペースを削除
terraform workspace delete old-workspace
```
